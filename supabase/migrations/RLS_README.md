# Row Level Security (RLS) Migrations

## üìã –û–±–∑–æ—Ä

–≠—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–∞—é—Ç Row Level Security (RLS) –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2024-12-22  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

---

## üîí –ß—Ç–æ –¥–µ–ª–∞—é—Ç —ç—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏?

### 1. `20241222_enable_rls_events.sql`

–í–∫–ª—é—á–∞–µ—Ç RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `events` —Å 7 –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏:

#### **SELECT Policies (—á—Ç–µ–Ω–∏–µ):**
- ‚úÖ `public` —Å–æ–±—ã—Ç–∏—è ‚Üí –≤–∏–¥–Ω—ã –≤—Å–µ–º (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–æ–≤)
- ‚úÖ `unlisted` —Å–æ–±—ã—Ç–∏—è ‚Üí –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ
- ‚úÖ `restricted` —Å–æ–±—ã—Ç–∏—è ‚Üí –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Å –¥–æ—Å—Ç—É–ø–æ–º
- ‚úÖ –í–ª–∞–¥–µ–ª—å—Ü—ã –≤–∏–¥—è—Ç —Å–≤–æ–∏ —Å–æ–±—ã—Ç–∏—è (–ª—é–±–æ–π visibility)

#### **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- ‚úÖ INSERT: —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å
- ‚úÖ UPDATE: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ DELETE: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å

---

### 2. `20241222_enable_rls_clubs.sql`

–í–∫–ª—é—á–∞–µ—Ç RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `clubs` —Å 4 –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏:

#### **–î–æ—Å—Ç—É–ø:**
- ‚úÖ SELECT: –≤—Å–µ –∫–ª—É–±—ã –≤–∏–¥–Ω—ã –≤—Å–µ–º (–¥–ª—è discovery)
- ‚úÖ INSERT: —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å
- ‚úÖ UPDATE: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã/–≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ DELETE: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. –û—Ç–∫—Ä–æ–π [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç **Need4Trip**
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **SQL Editor**
4. –°–∫–æ–ø–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `20241222_enable_rls_events.sql`
5. –í—Å—Ç–∞–≤—å –∏ –Ω–∞–∂–º–∏ **Run**
6. –î–æ–∂–¥–∏—Å—å —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
7. –ü–æ–≤—Ç–æ—Ä–∏ –¥–ª—è `20241222_enable_rls_clubs.sql`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ RLS –≤–∫–ª—é—á—ë–Ω
SELECT 
  schemaname, 
  tablename, 
  rowsecurity 
FROM pg_tables 
WHERE tablename IN ('events', 'clubs');

-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å rowsecurity = true –¥–ª—è –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü
```

---

### **–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Supabase CLI**

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
supabase db push

# –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
supabase db execute \
  --file supabase/migrations/20241222_enable_rls_events.sql
  
supabase db execute \
  --file supabase/migrations/20241222_enable_rls_clubs.sql
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RLS

### **–¢–µ—Å—Ç 1: –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ unlisted —Å–æ–±—ã—Ç–∏—é**

```javascript
// –ß–µ—Ä–µ–∑ Supabase client (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
const { data, error } = await supabase
  .from('events')
  .select('*')
  .eq('id', 'unlisted-event-id')
  .single();

// ‚úÖ –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–æ–±—ã—Ç–∏–µ (unlisted –≤–∏–¥–Ω—ã –≤—Å–µ–º)
```

---

### **–¢–µ—Å—Ç 2: –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ restricted —Å–æ–±—ã—Ç–∏—é**

```javascript
const { data, error } = await supabase
  .from('events')
  .select('*')
  .eq('id', 'restricted-event-id')
  .single();

// ‚ùå –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (restricted —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
```

---

### **–¢–µ—Å—Ç 3: –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å —á—É–∂–æ–µ —Å–æ–±—ã—Ç–∏–µ**

```javascript
// –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è B
const { error } = await supabase
  .from('events')
  .delete()
  .eq('id', 'event-by-user-b');

// ‚ùå –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É (RLS –∑–∞–ø—Ä–µ—Ç–∏—Ç —É–¥–∞–ª–µ–Ω–∏–µ)
```

---

### **–¢–µ—Å—Ç 4: –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–Ω–æ–Ω–∏–º–∞**

```javascript
const { data } = await supabase
  .from('events')
  .select('*');

// ‚úÖ –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ public + unlisted —Å–æ–±—ã—Ç–∏—è
// ‚ùå Restricted —Å–æ–±—ã—Ç–∏—è –ù–ï –¥–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è
```

---

## üîÑ –û—Ç–∫–∞—Ç (Rollback)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å RLS:

```sql
-- –û—Ç–∫–∞—Ç –¥–ª—è events
ALTER TABLE public.events DISABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "events_select_public" ON public.events;
DROP POLICY IF EXISTS "events_select_unlisted" ON public.events;
DROP POLICY IF EXISTS "events_select_restricted_with_access" ON public.events;
DROP POLICY IF EXISTS "events_select_own" ON public.events;
DROP POLICY IF EXISTS "events_insert_authenticated" ON public.events;
DROP POLICY IF EXISTS "events_update_own" ON public.events;
DROP POLICY IF EXISTS "events_delete_own" ON public.events;

-- –û—Ç–∫–∞—Ç –¥–ª—è clubs
ALTER TABLE public.clubs DISABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "clubs_select_all" ON public.clubs;
DROP POLICY IF EXISTS "clubs_insert_authenticated" ON public.clubs;
DROP POLICY IF EXISTS "clubs_update_admins" ON public.clubs;
DROP POLICY IF EXISTS "clubs_delete_owner_only" ON public.clubs;
```

‚ö†Ô∏è **–ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å** ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö!

---

## üìä –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (PostgreSQL –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: ~1-5ms –Ω–∞ –∑–∞–ø—Ä–æ—Å
- –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî –Ω–µ–∑–∞–º–µ—Ç–Ω–æ

### **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- PostgreSQL –∫–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã RLS –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ RLS

1. **Defense in Depth**: –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –¥–∞–∂–µ –µ—Å–ª–∏ API —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞**: –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—Ä—è–º—ã–µ SQL)
3. **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏**: –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç application-level –∑–∞—â–∏—Ç—ã
4. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞**: –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
5. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: Best practice –¥–ª—è Supabase/PostgreSQL

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Security Best Practices](https://supabase.com/docs/guides/auth/managing-user-data)

---

## üö® –°—Ç–∞—Ç—É—Å

- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã**
- ‚è≥ **–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Supabase Dashboard**
- ‚è≥ **–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –∑–∞—â–∏—â—ë–Ω –æ—Ç —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! üîí
