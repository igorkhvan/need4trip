# API Security Audit Report

**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2024  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** 20 API endpoints

## üìä –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –°—Ç–∞—Ç—É—Å |
|-----------|------------|--------|
| **–í—Å–µ–≥–æ endpoints** | 20 | ‚úÖ |
| **–¢—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** | 15 | ‚úÖ –ó–∞—â–∏—â–µ–Ω—ã |
| **–ü—É–±–ª–∏—á–Ω—ã–µ (read-only)** | 5 | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã |
| **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏** | 0 | ‚úÖ –ù–µ—Ç |

---

## üîê –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### ‚úÖ 1. AUTHENTICATION ENDPOINTS (3)

#### `/api/auth/telegram` (POST, GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Widget
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
  - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ HMAC-SHA256
  - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (`auth_date`)
  - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç replay-–∞—Ç–∞–∫
  - ‚úÖ Rate limiting —á–µ—Ä–µ–∑ –∫—ç—à (10 –º–∏–Ω—É—Ç)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/auth/logout` (POST, GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ auth cookie
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/auth/me` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö–æ–¥:**
```typescript
const user = await getCurrentUser();
if (!user) {
  return NextResponse.json({ error: "unauthorized" }, { status: 401 });
}
```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

---

### ‚úÖ 2. PUBLIC READ-ONLY ENDPOINTS (5)

#### `/api/cities` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ Read-only
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫/–ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** `?q=query`, `?popular=true`, `?ids=...`
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û** (public data)

#### `/api/cities/[id]` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ Read-only
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª–∏ –≥–æ—Ä–æ–¥–∞
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û** (public data)

#### `/api/car-brands` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ Read-only
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –º–∞—Ä–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û** (public data)

#### `/api/currencies` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ Read-only + RLS
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** Row Level Security –≤ Supabase
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û** (public data)

#### `/api/event-categories` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ Read-only
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–±—ã—Ç–∏–π
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û** (public data)

---

### ‚úÖ 3. EVENTS API (6 endpoints)

#### `/api/events` (GET, POST)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (—Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π)
- **POST:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  ```typescript
  const currentUser = await getCurrentUser();
  if (!currentUser) {
    throw new UnauthorizedError("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è");
  }
  ```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/events/[id]` (GET, PUT, DELETE)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏)
- **PUT:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –±—ã—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º
  ```typescript
  const currentUser = await getCurrentUser();
  await updateEvent(id, payload, currentUser); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏
  ```
- **DELETE:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –±—ã—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:** 
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`getCurrentUser()`)
  - –í–ª–∞–¥–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–µ–º (–≤–Ω—É—Ç—Ä–∏ `updateEvent`/`deleteEvent`)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/events/[id]/participants` (GET, POST)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (—Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- **POST:** ‚úÖ **–ß–ê–°–¢–ò–ß–ù–û –ó–ê–©–ò–©–ï–ù** - —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è –≥–æ—Å—Ç–µ–π
  ```typescript
  const currentUser = await getCurrentUser();
  // –ì–æ—Å—Ç–∏ –º–æ–≥—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  ```
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ì–æ—Å—Ç–µ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - —ç—Ç–æ feature, –Ω–µ —É—è–∑–≤–∏–º–æ—Å—Ç—å
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/events/[id]/participants/[participantId]` (PATCH, DELETE)
- **PATCH:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∏–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  ```typescript
  const currentUser = await getCurrentUser();
  const guestSessionId = currentUser ? null : await getGuestSessionId();
  await updateParticipant(participantId, payload, currentUser, guestSessionId);
  ```
- **DELETE:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∏–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT –∏–ª–∏ guest session
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è (–≤–Ω—É—Ç—Ä–∏ service)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

---

### ‚úÖ 4. CLUBS API (7 endpoints)

#### `/api/clubs` (GET, POST)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (—Å–ø–∏—Å–æ–∫ –∫–ª—É–±–æ–≤)
- **POST:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  ```typescript
  const user = await getCurrentUser();
  if (!user) {
    throw new UnauthorizedError("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞");
  }
  ```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/clubs/[id]` (GET, PATCH, DELETE)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (–¥–µ—Ç–∞–ª–∏ –∫–ª—É–±–∞)
- **PATCH:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –±—ã—Ç—å owner/organizer
  ```typescript
  const user = await getCurrentUser();
  await updateClub(id, body, user); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏
  ```
- **DELETE:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –±—ã—Ç—å owner
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`getCurrentUser()`)
  - –†–æ–ª—å –≤ –∫–ª—É–±–µ (–≤–Ω—É—Ç—Ä–∏ service)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/clubs/[id]/members` (GET, POST)
- **GET:** ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π (—Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–ª—É–±–∞)
- **POST:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç—Ä–µ–±—É–µ—Ç –±—ã—Ç—å owner/organizer
  ```typescript
  const user = await getCurrentUser();
  await addClubMember(id, userId, role, user); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏
  ```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/clubs/[id]/members/[userId]` (PATCH, DELETE)
- **PATCH:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ (owner/organizer)
  ```typescript
  const user = await getCurrentUser();
  await updateClubMemberRole(id, userId, role, user); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏
  ```
- **DELETE:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —É–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (owner/organizer)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/clubs/[id]/export` (GET)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - CSV export —Ç–æ–ª—å–∫–æ –¥–ª—è owner/organizer
  ```typescript
  const user = await getCurrentUser();
  if (!user) {
    throw new AuthError("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");
  }
  
  const canManage = await canManageClub(user, clubId);
  if (!canManage.allowed) {
    throw new AuthError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", undefined, 403);
  }
  ```
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  - –†–æ–ª—å –≤ –∫–ª—É–±–µ (`canManageClub`)
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/clubs/[id]/subscription` (PATCH)
- **–ó–∞—â–∏—Ç–∞:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
  ```typescript
  const user = await getCurrentUser();
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –≤–Ω—É—Ç—Ä–∏ updateClubSubscription()
  ```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

---

### ‚úÖ 5. PROFILE API (3 endpoints)

#### `/api/profile` (GET, PATCH)
- **GET:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
  ```typescript
  const user = await getCurrentUser();
  if (!user) {
    return NextResponse.json({ error: "unauthorized" }, { status: 401 });
  }
  ```
- **PATCH:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
  ```typescript
  const user = await getCurrentUser();
  if (!user) {
    throw new AuthError("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");
  }
  ```
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

#### `/api/profile/plan` (GET, PATCH)
- **GET:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
  ```typescript
  const user = await getCurrentUser();
  if (!user) {
    return NextResponse.json({ error: "unauthorized" }, { status: 401 });
  }
  ```
- **PATCH:** ‚úÖ **–ó–ê–©–ò–©–ï–ù** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
- **–°—Ç–∞—Ç—É—Å:** üü¢ **–ë–ï–ó–û–ü–ê–°–ù–û**

---

## üîí –ú–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã

### 1. JWT Authentication
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** HttpOnly cookie (`auth_token`)
- **–ê–ª–≥–æ—Ä–∏—Ç–º:** HS256
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** `getCurrentUser()` –≤ –∫–∞–∂–¥–æ–º protected endpoint
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
  - ‚úÖ –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è JavaScript (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
  - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
  - ‚úÖ SameSite=Lax (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF)

### 2. Authorization Checks
- **–£—Ä–æ–≤–µ–Ω—å 1:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (`getCurrentUser()`)
- **–£—Ä–æ–≤–µ–Ω—å 2:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–º (–≤ service layer)
- **–£—Ä–æ–≤–µ–Ω—å 3:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ –∫–ª—É–±–µ (`canManageClub`, `canEditEvent`)

### 3. Guest Sessions
- **–¶–µ–ª—å:** –ü–æ–∑–≤–æ–ª–∏—Ç—å –≥–æ—Å—Ç—è–º —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –ú–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** `guestSessionId` cookie + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

### 4. Input Validation
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** Zod schemas
- **–ì–¥–µ:** –ü–µ—Ä–µ–¥ –≤—Å–µ–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∑–∞–ø–∏—Å–∏ (create/update)
- **–ü—Ä–∏–º–µ—Ä—ã:** 
  - `eventCreateSchema`
  - `profileUpdateSchema`
  - `clubCreateSchema`

---

## ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ

### 1. Rate Limiting (TODO)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ rate limiting –¥–ª—è API  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å middleware —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤
```typescript
// src/middleware.ts
import { rateLimit } from '@/lib/rate-limit';

export async function middleware(request: NextRequest) {
  if (request.nextUrl.pathname.startsWith('/api/')) {
    const ip = request.ip ?? 'unknown';
    const isAllowed = await rateLimit(ip, {
      requests: 100,
      window: 60, // 100 requests per minute
    });
    
    if (!isAllowed) {
      return new NextResponse('Too Many Requests', { status: 429 });
    }
  }
}
```

### 2. CORS Configuration (TODO)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —è–≤–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å CORS headers –¥–ª—è API routes
```typescript
export async function OPTIONS(request: Request) {
  return new NextResponse(null, {
    status: 204,
    headers: {
      'Access-Control-Allow-Origin': process.env.NEXT_PUBLIC_APP_URL,
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, PATCH',
      'Access-Control-Allow-Headers': 'Content-Type',
    },
  });
}
```

### 3. Request Logging (TODO)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤
```typescript
// –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: timestamp, method, path, user_id, status_code, duration
```

### 4. API Keys –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (Future)
**–ö–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ public API –∏–ª–∏ webhooks  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É API keys –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

---

## ‚úÖ –í—ã–≤–æ–¥—ã

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: üü¢ **–í–´–°–û–ö–ê–Ø**

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (auth + ownership)
- ‚úÖ HttpOnly cookies (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
- ‚úÖ Input validation —á–µ—Ä–µ–∑ Zod schemas
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π Telegram —Å replay protection
- ‚úÖ Guest sessions –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
1. ‚úÖ –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–∏–º –¥–∞–Ω–Ω—ã–º
2. ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ endpoints —Ç–æ–ª—å–∫–æ –¥–ª—è read-only –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º/—É–¥–∞–ª–µ–Ω–∏–µ–º
5. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å—ã (401, 403, 404)

**–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π! ‚úÖ**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ:**
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å rate limiting (DOS –∑–∞—â–∏—Ç–∞)
- ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å request logging (–¥–ª—è –∞—É–¥–∏—Ç–∞)

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** AI Assistant  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ endpoints:** 20/20  
**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2024

