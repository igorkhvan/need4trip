# –ê–Ω–∞–ª–∏–∑ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–∏–ø–æ–≤ –∞–≤—Ç–æ –≤ —Ñ–æ—Ä–º–∞—Ö –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏

**–î–∞—Ç–∞:** 28 –¥–µ–∫–∞–±—Ä—è 2024  
**–°—Ç–∞—Ç—É—Å:** –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

---

## üìã –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ —Ç–∏–ø—É –∞–≤—Ç–æ" –∏–∑ —Å–ø–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–∏–ø–∞–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º–∏ –∑–∞—Ç–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–æ–±—ã—Ç–∏—è.

**–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:** –î–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –ø–æ–Ω—è—Ç–∏—è (—Ç–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è).

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö (SSOT)

#### –¢–∞–±–ª–∏—Ü–∞ `vehicle_types` (—Å–æ–∑–¥–∞–Ω–∞ 2024-12-16)

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `20241216_create_vehicle_types.sql`

**–î–∞–Ω–Ω—ã–µ:**
```sql
INSERT INTO public.vehicle_types (id, name_en, name_ru, display_order, is_active) VALUES
  ('offroad', 'Offroad', '–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫', 1, true),
  ('sedan', 'Sedan', '–°–µ–¥–∞–Ω', 2, true),
  ('suv', 'SUV / Crossover', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä', 3, true),
  ('sportcar', 'Sports Car', '–°–ø–æ—Ä—Ç–∫–∞—Ä', 4, true),
  ('classic', 'Classic', '–ö–ª–∞—Å—Å–∏–∫–∞', 5, true),
  ('other', 'Other', '–î—Ä—É–≥–æ–µ', 6, true);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- Single Source of Truth –¥–ª—è —Ç–∏–ø–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `user_cars.type` (constraint)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ö (–ø—Ä–æ—Ñ–∏–ª—å, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ)
- **–î–û–õ–ñ–ï–ù** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–æ–±—ã—Ç–∏—è—Ö (`events.vehicle_type_requirement`)

---

### 2. –§–æ—Ä–º–∞ –°–æ–∑–¥–∞–Ω–∏—è –°–æ–±—ã—Ç–∏—è

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `EventVehicleSection`

**–§–∞–π–ª:** `src/components/events/event-form/sections/event-vehicle-section.tsx`

**–ö–æ–¥:**
```tsx
<Select
  value={vehicleType}
  onValueChange={(val) => onVehicleTypeChange(val as VehicleTypeRequirement)}
>
  <SelectItem value="any">–õ—é–±–æ–π</SelectItem>
  {vehicleTypes.map((type) => (
    <SelectItem key={type.value} value={type.value}>
      {type.label}
    </SelectItem>
  ))}
</SelectContent>
```

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:**
```tsx
// src/components/events/event-form.tsx (—Å—Ç—Ä–æ–∫–∞ 202-225)
const [brandsRes, typesRes] = await Promise.all([
  fetch("/api/car-brands"),
  fetch("/api/vehicle-types"),  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô API
]);

if (typesRes.ok) {
  const typesData = await typesRes.json();
  const types = typesData.data?.vehicleTypes || typesData.vehicleTypes || [];
  setVehicleTypes(types);  // ‚úÖ –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î
}
```

**API Endpoint:** `GET /api/vehicle-types`

**–§–∞–π–ª:** `src/app/api/vehicle-types/route.ts`

**–ö–æ–¥:**
```typescript
export async function GET() {
  const vehicleTypes = await getActiveVehicleTypes();
  
  const options = vehicleTypes.map(type => ({
    value: type.id,      // 'offroad', 'sedan', 'suv', 'sportcar', 'classic', 'other'
    label: type.nameRu,  // '–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫', '–°–µ–¥–∞–Ω', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä', '–°–ø–æ—Ä—Ç–∫–∞—Ä', '–ö–ª–∞—Å—Å–∏–∫–∞', '–î—Ä—É–≥–æ–µ'
  }));
  
  return respondSuccess({ vehicleTypes: options });
}
```

**–í—ã–≤–æ–¥:**
‚úÖ **–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –ü–†–ê–í–ò–õ–¨–ù–û –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–∏–ø—ã –∏–∑ –ë–î —á–µ—Ä–µ–∑ API**

---

### 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –°–æ–±—ã—Ç–∏—è

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è

**–§–∞–π–ª:** `src/app/(app)/events/[id]/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 77-83)

**–ö–æ–¥:**
```tsx
const vehicleTypeLabelMap: Record<string, string> = {
  any: "–õ—é–±–æ–π",
  sedan: "–õ–µ–≥–∫–æ–≤–æ–π",      // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –í –ë–î: "–°–µ–¥–∞–Ω"
  crossover: "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä", // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –í –ë–î –Ω–µ—Ç 'crossover', –µ—Å—Ç—å 'suv'
  suv: "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫",     // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –í –ë–î 'suv' = "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä", –∞ 'offroad' = "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"
};
const vehicleTypeLabel = vehicleTypeLabelMap[event.vehicleTypeRequirement] ?? "–õ—é–±–æ–π";
```

**–í—ã–≤–æ–¥:**
‚ùå **–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HARDCODED mapping, –∫–æ—Ç–æ—Ä—ã–π –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ë–î**

---

## üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| ID –≤ –ë–î | –ù–∞–∑–≤–∞–Ω–∏–µ –≤ –ë–î (name_ru) | –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è ‚úÖ | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è ‚ùå |
|---------|-------------------------|-------------------|---------------------|
| `offroad` | –í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ | ‚úÖ –í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ | ‚ùå (–Ω–µ—Ç –≤ mapping) |
| `sedan` | –°–µ–¥–∞–Ω | ‚úÖ –°–µ–¥–∞–Ω | ‚ùå "–õ–µ–≥–∫–æ–≤–æ–π" |
| `suv` | –ö—Ä–æ—Å—Å–æ–≤–µ—Ä | ‚úÖ –ö—Ä–æ—Å—Å–æ–≤–µ—Ä | ‚ùå "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫" |
| `sportcar` | –°–ø–æ—Ä—Ç–∫–∞—Ä | ‚úÖ –°–ø–æ—Ä—Ç–∫–∞—Ä | ‚ùå (–Ω–µ—Ç –≤ mapping) |
| `classic` | –ö–ª–∞—Å—Å–∏–∫–∞ | ‚úÖ –ö–ª–∞—Å—Å–∏–∫–∞ | ‚ùå (–Ω–µ—Ç –≤ mapping) |
| `other` | –î—Ä—É–≥–æ–µ | ‚úÖ –î—Ä—É–≥–æ–µ | ‚ùå (–Ω–µ—Ç –≤ mapping) |
| `crossover` | (–Ω–µ—Ç –≤ –ë–î) | ‚ùå | ‚úÖ "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä" |

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **`sedan`**: –í —Ñ–æ—Ä–º–µ "–°–µ–¥–∞–Ω" ‚Üí –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–õ–µ–≥–∫–æ–≤–æ–π"
2. **`suv`**: –í —Ñ–æ—Ä–º–µ "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä" ‚Üí –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"
3. **`offroad`**: –í —Ñ–æ—Ä–º–µ "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫" ‚Üí –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
4. **`sportcar`, `classic`, `other`**: –î–æ—Å—Ç—É–ø–Ω—ã –≤ —Ñ–æ—Ä–º–µ, –Ω–æ –Ω–µ—Ç mapping –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
5. **`crossover`**: –í mapping –µ—Å—Ç—å, –Ω–æ –≤ –ë–î –ù–ï–¢ —Ç–∞–∫–æ–≥–æ ID

---

## üéØ –ü–û–°–õ–ï–î–°–¢–í–ò–Ø

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å —Ç–∏–ø–æ–º "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"

1. ‚úÖ –§–æ—Ä–º–∞: –í—ã–±–∏—Ä–∞–µ—Ç "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫" ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `vehicle_type_requirement = 'offroad'`
2. ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è: `vehicleTypeLabelMap['offroad']` = `undefined` ‚Üí fallback "–õ—é–±–æ–π"
3. ‚ùó **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–õ—é–±–æ–π" –≤–º–µ—Å—Ç–æ "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"**

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å —Ç–∏–ø–æ–º "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä"

1. ‚úÖ –§–æ—Ä–º–∞: –í—ã–±–∏—Ä–∞–µ—Ç "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä" ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `vehicle_type_requirement = 'suv'`
2. ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è: `vehicleTypeLabelMap['suv']` = "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"
3. ‚ùó **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫" –≤–º–µ—Å—Ç–æ "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä"**

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å —Ç–∏–ø–æ–º "–°–µ–¥–∞–Ω"

1. ‚úÖ –§–æ—Ä–º–∞: –í—ã–±–∏—Ä–∞–µ—Ç "–°–µ–¥–∞–Ω" ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `vehicle_type_requirement = 'sedan'`
2. ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è: `vehicleTypeLabelMap['sedan']` = "–õ–µ–≥–∫–æ–≤–æ–π"
3. ‚ùó **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–õ–µ–≥–∫–æ–≤–æ–π" –≤–º–µ—Å—Ç–æ "–°–µ–¥–∞–Ω"**

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –ú–ï–°–¢–ê –í –ö–û–î–ï

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –ë–î)

1. ‚úÖ **–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è**
   - `src/components/events/event-form.tsx` (—Å—Ç—Ä–æ–∫–∏ 202-225)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç API `/api/vehicle-types`

2. ‚úÖ **–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ)**
   - `src/components/profile/profile-page-client.tsx` (—Å—Ç—Ä–æ–∫–∏ 207-211)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç API `/api/vehicle-types`
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å—Ç—Ä–æ–∫–∞ 1104 (`vehicleTypes.find(t => t.value === car.type)?.label`)

3. ‚úÖ **API**
   - `src/app/api/vehicle-types/route.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getActiveVehicleTypes()` –∏–∑ `vehicleTypeRepo.ts`

4. ‚úÖ **Repository**
   - `src/lib/db/vehicleTypeRepo.ts`
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `StaticCache` (TTL 24 —á–∞—Å–∞)

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞ (hardcoded mapping)

1. ‚ùå **–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è**
   - `src/app/(app)/events/[id]/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 77-83)
   - Hardcoded `vehicleTypeLabelMap`

2. ‚ùì **–î—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞?**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: Event cards (`event-card-compact.tsx`, `event-card-detailed.tsx`) –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Ç–∏–ø—ã –∞–≤—Ç–æ
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –°–ø–∏—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ –∂–µ –∫–∞—Ä—Ç–æ—á–∫–∏
   - ‚ö†Ô∏è –§–∏–ª—å—Ç—Ä—ã ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∞–≤—Ç–æ)

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ó–ê–ú–ï–¢–ö–ò

### Database (SSOT)

**–¢–∞–±–ª–∏—Ü–∞:** `vehicle_types`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ `20241216_create_vehicle_types.sql`
- ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω (–ø—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤)
- ‚úÖ Cached —á–µ—Ä–µ–∑ `StaticCache` (24h TTL)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- `user_cars.type` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CHECK constraint —Å –∂–µ—Å—Ç–∫–∏–º —Å–ø–∏—Å–∫–æ–º: `('offroad', 'sedan', 'suv', 'sportcar', 'classic', 'other')`
- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è constraint

### Events (–≥–∏–±–∫–∏–π)

**–ö–æ–ª–æ–Ω–∫–∞:** `events.vehicle_type_requirement TEXT NOT NULL DEFAULT 'any'`
- ‚úÖ –ù–ï–¢ CHECK constraint
- ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å `'any'` –∏–ª–∏ ID –∏–∑ `vehicle_types`
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π

**–¢–∏–ø TypeScript:**
```typescript
export const vehicleTypeRequirementSchema = z.union([
  z.literal("any"),
  vehicleTypeIdSchema,
]);
```

### Hydration Patterns

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- ‚ùå –ù–ï–¢ hydration –¥–ª—è `event.vehicleTypeRequirement`
- –°–æ–±—ã—Ç–∏—è –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ç–æ–ª—å–∫–æ ID —Ç–∏–ø–∞: `'offroad'`, `'sedan'`, etc.

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ hydration utilities:**
- `hydrateCities()` ‚Üí cities
- `hydrateCurrencies()` ‚Üí currencies
- `hydrateEventCategories()` ‚Üí event categories

**SSOT:** `docs/ARCHITECTURE.md` ¬ß Ownership Map
- Hydration: `src/lib/utils/hydration.ts`

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –í–∞—Ä–∏–∞–Ω—Ç 1: Hydration Pattern (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø ‚úÖ)

**–ü–æ—á–µ–º—É:**
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ reference data (cities, currencies, categories)
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `hydration.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–∏—Ç—å hydration –≤ `src/lib/utils/hydration.ts`:**
```typescript
export async function hydrateVehicleTypes<T extends { vehicleTypeRequirement: string }>(
  items: T[]
): Promise<Array<T & { vehicleType?: VehicleType | null }>> {
  const typeIds = items
    .map(item => item.vehicleTypeRequirement)
    .filter(id => id !== 'any');
  
  if (typeIds.length === 0) {
    return items.map(item => ({ ...item, vehicleType: null }));
  }
  
  const typesMap = await getVehicleTypesByIds([...new Set(typeIds)]);
  
  return items.map(item => ({
    ...item,
    vehicleType: item.vehicleTypeRequirement === 'any' 
      ? null 
      : typesMap.get(item.vehicleTypeRequirement) ?? null,
  }));
}
```

2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã Event:**
```typescript
export interface Event {
  // ... existing fields
  vehicleTypeRequirement: VehicleTypeRequirement;
  vehicleType?: VehicleType | null; // Hydrated
}
```

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å hydration –≤ repo/services:**
```typescript
// src/lib/db/eventRepo.ts
export async function getEventById(id: string): Promise<Event | null> {
  // ... load event
  const [hydrated] = await hydrateVehicleTypes([event]);
  return hydrated;
}
```

4. **–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è:**
```tsx
// src/app/(app)/events/[id]/page.tsx
const vehicleTypeLabel = event.vehicleType?.nameRu ?? "–õ—é–±–æ–π";
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ Single Source of Truth (–ë–î)
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (StaticCache)
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã
- ‚úÖ Type-safe

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: API Helper (–±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

**–ü–æ—á–µ–º—É:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ë—ã—Å—Ç—Ä–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å helper —É—Ç–∏–ª–∏—Ç—É:**
```typescript
// src/lib/utils/vehicleTypeLabels.ts
import { getVehicleTypeById } from "@/lib/db/vehicleTypeRepo";

const cache = new Map<string, string>();

export async function getVehicleTypeLabel(
  typeId: string
): Promise<string> {
  if (typeId === 'any') return "–õ—é–±–æ–π";
  
  if (cache.has(typeId)) {
    return cache.get(typeId)!;
  }
  
  const type = await getVehicleTypeById(typeId);
  const label = type?.nameRu ?? "–õ—é–±–æ–π";
  cache.set(typeId, label);
  
  return label;
}
```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–æ–±—ã—Ç–∏—è:**
```tsx
// src/app/(app)/events/[id]/page.tsx
const vehicleTypeLabel = await getVehicleTypeLabel(event.vehicleTypeRequirement);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î –∫–∞–∫ SSOT

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É hydration
- ‚ùå –ù–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ç–∏–ø—ã Event
- ‚ùå –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π API call –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: Client-side Lookup (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–ó–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ –¥–µ–ª–∞—Ç—å lookup –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

**–ü–æ—á–µ–º—É –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Server + Client)
- ‚ùå –ù–µ SSR-friendly
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

---

## üìÅ –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –í–∞—Ä–∏–∞–Ω—Ç–∞ 1 (Hydration)

1. ‚úèÔ∏è **src/lib/utils/hydration.ts**
   - –î–æ–±–∞–≤–∏—Ç—å `hydrateVehicleTypes()`

2. ‚úèÔ∏è **src/lib/types/event.ts**
   - –û–±–Ω–æ–≤–∏—Ç—å `Event` interface (–¥–æ–±–∞–≤–∏—Ç—å `vehicleType?: VehicleType | null`)

3. ‚úèÔ∏è **src/lib/db/eventRepo.ts**
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å hydration –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏—Ö —Å–æ–±—ã—Ç–∏—è
   - `getEventById()`, `listEvents()`, `listEventsByClub()`, etc.

4. ‚úèÔ∏è **src/app/(app)/events/[id]/page.tsx**
   - –£–±—Ä–∞—Ç—å `vehicleTypeLabelMap`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `event.vehicleType?.nameRu ?? "–õ—é–±–æ–π"`

5. üîç **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
   - ‚úÖ Event cards (`src/components/events/event-card*.tsx`) ‚Äî –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Ç–∏–ø—ã –∞–≤—Ç–æ
   - ‚ö†Ô∏è Event lists / —Ñ–∏–ª—å—Ç—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

6. ‚úèÔ∏è **docs/ARCHITECTURE.md**
   - –û–±–Ω–æ–≤–∏—Ç—å Ownership Map (–¥–æ–±–∞–≤–∏—Ç—å Vehicle Types ‚Üí hydration.ts)

### –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –í–∞—Ä–∏–∞–Ω—Ç–∞ 2 (Helper)

1. ‚ú® **src/lib/utils/vehicleTypeLabels.ts** (—Å–æ–∑–¥–∞—Ç—å)
   - –î–æ–±–∞–≤–∏—Ç—å `getVehicleTypeLabel()`

2. ‚úèÔ∏è **src/app/(app)/events/[id]/page.tsx**
   - –£–±—Ä–∞—Ç—å `vehicleTypeLabelMap`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `await getVehicleTypeLabel(event.vehicleTypeRequirement)`

3. üîç **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è**

---

## ‚úÖ CHECKLIST –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

- [ ] –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –í–∞—Ä–∏–∞–Ω—Ç 1)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –∞–≤—Ç–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
  - [ ] –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
  - [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è
  - [ ] Event cards
  - [ ] –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `docs/ARCHITECTURE.md` (Ownership Map)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
- [ ] –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ó–ê–ú–ï–¢–ö–ò

### –ò—Å—Ç–æ—Ä–∏—è

1. **2024-12-14:** –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `user_cars` —Å constraint –Ω–∞ —Ç–∏–ø—ã
2. **2024-12-16:** –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `vehicle_types` –∫–∞–∫ SSOT
3. **2024-12-16:** –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API
4. **–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏—è –ù–ï –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚Üí hardcoded mapping

### –ü—Ä–æ–≤–µ—Ä–∫–∞ constraint –≤ user_cars

–¢–µ–∫—É—â–∏–π constraint –≤ `user_cars.type`:
```sql
CHECK (type IN ('offroad', 'sedan', 'suv', 'sportcar', 'classic', 'other'))
```

**–í–æ–ø—Ä–æ—Å:** –ù—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å constraint –Ω–∞ FK –∫ `vehicle_types`?

**–û—Ç–≤–µ—Ç:**
- **–ü–ª—é—Å—ã FK:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, referential integrity
- **–ú–∏–Ω—É—Å—ã FK:** –°–ª–æ–∂–Ω–µ–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è UPDATE —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π)
- **–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ (CHECK constraint):** –ì–∏–±–∫–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–∏–ø–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å CHECK constraint, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ë–î —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–í—ã–±—Ä–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 1 (Hydration Pattern):**

1. ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (ARCHITECTURE.md)
2. ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å cities, currencies, categories
3. ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
4. ‚úÖ Type-safe
5. ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –∫–æ—Ä–æ–±–∫–∏

**–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è (4-6 —á–∞—Å–æ–≤)

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:** ~6-8 —Ñ–∞–π–ª–æ–≤

**Risks:** –ù–∏–∑–∫–∏–π (–ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞ –¥—Ä—É–≥–∏—Ö reference data)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

