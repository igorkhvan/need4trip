# ðŸ“‹ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³Ð° Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Need4Trip

> **Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¸ÑÑ‚Ð¸Ð½Ñ‹ Ð´Ð»Ñ Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð², Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð¸ paywall Ð»Ð¾Ð³Ð¸ÐºÐ¸**

---

## 0) Ð¦ÐµÐ»ÑŒ Ð¸ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹

### Ð¦ÐµÐ»ÑŒ
Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³ Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·ÑƒÐµÐ¼Ð¾, Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‚Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ð³Ð¸Ð±ÐºÐ¾ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð‘Ð”.

### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹

1. **Frontend Ð½Ðµ Ñ€ÐµÑˆÐ°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿**  
   Ð¤Ñ€Ð¾Ð½Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ UI Ð¸ Ñ€ÐµÐ°Ð³Ð¸Ñ€ÑƒÐµÑ‚ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ backend.

2. **Backend â€” ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¸ÑÑ‚Ð¸Ð½Ñ‹**  
   ÐŸÐ¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñƒ, Ð»Ð¸Ð¼Ð¸Ñ‚Ð°Ð¼, grace Ð¸ paywall.

3. **Ð¦ÐµÐ½Ñ‹ Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ â€” Ð² Ð‘Ð”**  
   Seed + API `/api/plans`.

4. **ÐŸÐ¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‚Ðµ â€” Ð² Ð‘Ð”**  
   Grace period, Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð² `pending`/`grace`/`expired`.

5. **Ð¢Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸ Ð½Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð² Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°Ñ… Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°**  
   `billing_transactions` â€” Ð°ÑƒÐ´Ð¸Ñ‚/Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ. Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ ÐºÐ»ÑƒÐ±Ð°.

---

## 1) Ð¢ÐµÑ€Ð¼Ð¸Ð½Ñ‹

| Ð¢ÐµÑ€Ð¼Ð¸Ð½ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
|--------|----------|
| **User** | ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ (Telegram) |
| **Club** | ÐŸÐ»Ð°Ñ‚Ð½Ð°Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ (Ð² Free ÐºÐ»ÑƒÐ± ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ) |
| **Plan** | Ð¢Ð°Ñ€Ð¸Ñ„ ÐºÐ»ÑƒÐ±Ð° (`Club 50` / `Club 500` / `Unlimited`) |
| **Subscription** | Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ ÐºÐ»ÑƒÐ±Ð°: `active`/`grace`/`expired`/`pending` |
| **Limits** | Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ñ‚Ð°Ñ€Ð¸Ñ„Ð° (max_members, max_event_participants, paid events, CSV export) |
| **Actions** | ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ñ‹/Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ñ‹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ |
| **Billing policy** | ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° grace Ð¸ Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ðµ actions Ð¿Ñ€Ð¸ pending/grace/expired |

---

## 2) ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### 2.1 Free (Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼)

**ÐšÐ»ÑƒÐ± ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ.**

ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚:
- âœ… Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ (Ð½Ðµ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ðº ÐºÐ»ÑƒÐ±Ñƒ)
- âœ… Ð”ÐµÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¼Ð¸
- âœ… Ð›Ð¸Ð¼Ð¸Ñ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: **15**
- âŒ CSV ÑÐºÑÐ¿Ð¾Ñ€Ñ‚: Ð½ÐµÐ»ÑŒÐ·Ñ

**Important:** 
- Free Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ»ÑƒÐ±Ð½Ñ‹Ð¼ Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð¼. Ð­Ñ‚Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼ **"Ð±ÐµÐ· ÐºÐ»ÑƒÐ±Ð°"**.
- **Since v2.1:** FREE Ð¿Ð»Ð°Ð½ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ `club_plans` (id='free') Ð´Ð»Ñ ÑƒÐ½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸.
- Ð’ÑÐµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ FREE Ð¿Ð»Ð°Ð½Ð° Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ð¸Ð· Ð‘Ð” Ñ‡ÐµÑ€ÐµÐ· `getPlanById('free')`.

### 2.2 ÐšÐ»ÑƒÐ±Ñ‹ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ

- ÐšÐ»ÑƒÐ± ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ **Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹** (Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°)
- ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»ÑƒÐ±Ð½Ñ‹Ð¹ Ñ‚Ð°Ñ€Ð¸Ñ„: **Club 50**

---

## 3) ÐŸÐµÑ€ÐµÑ‡ÐµÐ½ÑŒ Actions (ÐºÐ°Ð½Ð¾Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº)

Ð¥Ñ€Ð°Ð½Ð¸Ð¼ Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð½Ð°Ð±Ð¾Ñ€ ÐºÐ¾Ð´Ð¾Ð² (enum-like):

### Club actions

```typescript
enum ClubAction {
  CLUB_CREATE = 'CLUB_CREATE',                        // ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ± (Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹)
  CLUB_UPDATE = 'CLUB_UPDATE',                        // Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±
  CLUB_INVITE_MEMBER = 'CLUB_INVITE_MEMBER',          // Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐ°Ñ‚ÑŒ/Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
  CLUB_REMOVE_MEMBER = 'CLUB_REMOVE_MEMBER',          // ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
  CLUB_CREATE_EVENT = 'CLUB_CREATE_EVENT',            // ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±Ð½Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  CLUB_UPDATE_EVENT = 'CLUB_UPDATE_EVENT',            // Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±Ð½Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  CLUB_EXPORT_PARTICIPANTS_CSV = 'CLUB_EXPORT_PARTICIPANTS_CSV',  // ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
  CLUB_CREATE_PAID_EVENT = 'CLUB_CREATE_PAID_EVENT',  // ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
}
```

### Event actions (personal/free)

```typescript
enum PersonalAction {
  PERSONAL_CREATE_EVENT = 'PERSONAL_CREATE_EVENT',
  PERSONAL_CREATE_PAID_EVENT = 'PERSONAL_CREATE_PAID_EVENT',  // Ð² Free Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾
}
```

---

## 4) ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð‘Ð” (Ð²ÑÑ‘ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼Ð¾Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð‘Ð”)

### 4.1 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `club_plans` (Ñ†ÐµÐ½Ñ‹ + Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ + Ñ„Ð¸Ñ‡Ð¸ Ñ‚Ð°Ñ€Ð¸Ñ„Ð°)

Ð­Ñ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ seed Ð¸ `/api/plans`.

```sql
CREATE TABLE public.club_plans (
  id TEXT PRIMARY KEY,                         -- free | club_50 | club_500 | unlimited
  title TEXT NOT NULL,

  price_monthly_kzt NUMERIC(10,2) NOT NULL,    -- 0 Ð´Ð»Ñ free, Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð² Ñ‚ÐµÐ½Ð³Ðµ
  currency TEXT NOT NULL DEFAULT 'KZT',

  max_members INT NULL,                        -- NULL = unlimited (Ð¸Ð»Ð¸ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾ Ð´Ð»Ñ free)
  max_event_participants INT NULL,             -- NULL = unlimited

  allow_paid_events BOOLEAN NOT NULL,
  allow_csv_export BOOLEAN NOT NULL,

  is_public BOOLEAN NOT NULL DEFAULT true,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

**ðŸ“Œ Since v2.1:** FREE Ð¿Ð»Ð°Ð½ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ Ñ `id='free'` Ð´Ð»Ñ ÑƒÐ½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹.
- `price_monthly_kzt = 0.00`
- `max_event_participants = 15`
- `allow_paid_events = false`
- `allow_csv_export = false`
- `max_members = NULL` (ÐºÐ»ÑƒÐ±Ñ‹ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð½Ð° FREE)

**ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°:**
- âœ… Ð•Ð´Ð¸Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¸ÑÑ‚Ð¸Ð½Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð»Ð°Ð½Ð¾Ð²
- âœ… Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ FREE Ñ‡ÐµÑ€ÐµÐ· Ð‘Ð”
- âœ… Ð£Ð½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ (Ð½ÐµÑ‚ `if (plan === 'free')` Ñ hardcoded Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸)
- âœ… ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð»Ð°Ð½Ð¾Ð² Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ð¾

### 4.2 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `billing_policy` (grace, allowed actions Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‚Ðµ)

Ð—Ð´ÐµÑÑŒ Ð¶Ð¸Ð²Ñ‘Ñ‚ Ð²ÑÑ‘ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ "ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ".

```sql
CREATE TABLE public.billing_policy (
  id TEXT PRIMARY KEY,                          -- 'default'
  grace_period_days INT NOT NULL DEFAULT 7,     -- Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ grace

  -- Ð•ÑÐ»Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ†Ð¸Ð¸:
  pending_ttl_minutes INT NOT NULL DEFAULT 60,  -- ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð´ÐµÑ€Ð¶Ð¸Ð¼ pending payment intent

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

**Seed:**
```sql
INSERT INTO public.billing_policy (id, grace_period_days, pending_ttl_minutes)
VALUES ('default', 7, 60);
```

### 4.3 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `billing_policy_actions` (Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ðµ actions Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ)

ÐšÐ»ÑŽÑ‡ÐµÐ²Ð¾Ðµ: ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð² `pending`/`grace`/`expired`, Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² Ð‘Ð”.

```sql
CREATE TABLE public.billing_policy_actions (
  policy_id TEXT NOT NULL REFERENCES billing_policy(id) ON DELETE CASCADE,
  status TEXT NOT NULL CHECK (status IN ('pending','grace','expired')),
  action TEXT NOT NULL,                         -- Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° actions
  is_allowed BOOLEAN NOT NULL DEFAULT false,

  PRIMARY KEY (policy_id, status, action)
);
```

**Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ð¹ baseline:**
- **pending:** Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€, Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹, Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼)
- **grace:** Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÑ‘ (SaaS-Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°), Ð½Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ñ‚Ð½Ñ‹Ñ…/ÑÐºÑÐ¿Ð¾Ñ€Ñ‚
- **expired:** read-only + Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ/Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ seed (ÐºÐ¾Ð½Ñ†ÐµÐ¿Ñ‚):**

```sql
-- expired: read-only
INSERT INTO public.billing_policy_actions (policy_id, status, action, is_allowed)
VALUES 
  ('default', 'expired', 'CLUB_UPDATE', false),
  ('default', 'expired', 'CLUB_CREATE_EVENT', false),
  ('default', 'expired', 'CLUB_CREATE_PAID_EVENT', false),
  ('default', 'expired', 'CLUB_EXPORT_PARTICIPANTS_CSV', false);

-- grace: Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÑ‘ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¾
INSERT INTO public.billing_policy_actions (policy_id, status, action, is_allowed)
VALUES 
  ('default', 'grace', 'CLUB_CREATE_EVENT', true),
  ('default', 'grace', 'CLUB_CREATE_PAID_EVENT', true),
  ('default', 'grace', 'CLUB_EXPORT_PARTICIPANTS_CSV', true);

-- pending: Ð²ÑÑ‘ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ (ÐºÑ€Ð¾Ð¼Ðµ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ action)
```

### 4.4 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `club_subscriptions` (Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ ÐºÐ»ÑƒÐ±Ð°)

Enforcement ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚ ÑÑŽÐ´Ð° + Ð² `club_plans` + `policy`.

```sql
CREATE TABLE public.club_subscriptions (
  club_id UUID PRIMARY KEY REFERENCES clubs(id) ON DELETE CASCADE,

  plan_id TEXT NOT NULL REFERENCES club_plans(id),
  status TEXT NOT NULL CHECK (status IN ('pending','active','grace','expired')),

  current_period_start TIMESTAMPTZ NULL,
  current_period_end TIMESTAMPTZ NULL,

  grace_until TIMESTAMPTZ NULL,                 -- Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ÑÑ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ policy
  updated_at TIMESTAMPTZ DEFAULT now(),
  created_at TIMESTAMPTZ DEFAULT now()
);
```

**Ð’Ð°Ð¶Ð½Ð¾:** `club_subscriptions` â€” Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ. Ð­Ñ‚Ð¾ Ñ‚Ð¾, Ð½Ð° Ñ‡Ñ‚Ð¾ Ð¾Ð¿Ð¸Ñ€Ð°ÐµÑ‚ÑÑ Ð´Ð¾ÑÑ‚ÑƒÐ¿.

### 4.5 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `billing_transactions` (Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ/Ð°ÑƒÐ´Ð¸Ñ‚ Ð´ÐµÐ½ÐµÐ³)

```sql
CREATE TABLE public.billing_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  plan_id TEXT NOT NULL REFERENCES club_plans(id),

  provider TEXT NOT NULL,                       -- kaspi | epay | ...
  provider_payment_id TEXT,

  amount_kzt NUMERIC(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'KZT',

  status TEXT NOT NULL CHECK (status IN ('pending','paid','failed','refunded')),

  period_start TIMESTAMPTZ NULL,
  period_end TIMESTAMPTZ NULL,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_billing_transactions_club_id ON public.billing_transactions (club_id);
CREATE INDEX idx_billing_transactions_status ON public.billing_transactions (status);
```

### 4.6 Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÐºÐ»ÑƒÐ±Ð¾Ð² Ð¸ Ñ‡Ð»ÐµÐ½ÑÑ‚Ð²Ð° (Ð´Ð»Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð° max_members)

```sql
CREATE TABLE public.club_members (
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner','admin','member')),
  created_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (club_id, user_id)
);

CREATE INDEX idx_club_members_user_id ON public.club_members(user_id);
```

### 4.7 ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ð¾Ñ€Ð¾Ð´Ð° Ð´Ð»Ñ ÐºÐ»ÑƒÐ±Ð¾Ð²

ÐšÐ»ÑƒÐ± Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½ Ðº Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼ Ð³Ð¾Ñ€Ð¾Ð´Ð°Ð¼.

```sql
CREATE TABLE public.club_cities (
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  city_id UUID NOT NULL REFERENCES cities(id) ON DELETE RESTRICT,
  PRIMARY KEY (club_id, city_id)
);

CREATE INDEX idx_club_cities_city_id ON public.club_cities(city_id);
```

---

## 5) Flow: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ»ÑƒÐ±Ð° (Free Ð·Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½)

### 5.1 UX flow (Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²Ñ‹Ð¹)

1. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¶Ð¸Ð¼Ð°ÐµÑ‚ **"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±"**
2. Backend Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚: ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¿Ñ€Ð°Ð²Ð¾ `CLUB_CREATE` Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
3. Ð¢Ð°Ðº ÐºÐ°Ðº Free â€” ÐºÐ»ÑƒÐ±Ð¾Ð² Ð½ÐµÑ‚, Ð´Ð¾ÑÑ‚ÑƒÐ¿ = **paywall** (Ð½ÑƒÐ¶ÐµÐ½ Club 50)
4. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ñ‚Ð°Ñ€Ð¸Ñ„ Ð½Ð° `/pricing`
5. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ð° (payment intent)
6. ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹:
   - ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ ÐºÐ»ÑƒÐ±
   - ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° `active`
   - ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ Ð·Ð°Ð¿Ð¸ÑÑŒ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸ `paid`

### 5.2 ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ð¾ Ð²Ð°Ð¶Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)

**ÐÐµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ clubs Ð´Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹.**

Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð»Ð¾Ð´Ð¸Ñ‚ÑŒ "Ð¿Ð¾Ð»ÑƒÐ¼Ñ‘Ñ€Ñ‚Ð²Ñ‹Ðµ" ÐºÐ»ÑƒÐ±Ñ‹, Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð¸Ð· Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²:

- **Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ A (Ð»ÑƒÑ‡ÑˆÐ¸Ð¹):** `club_drafts` (Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹)
- **Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ B:** Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ draft Ð² client/local storage (Ð¼ÐµÐ½ÐµÐµ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾)

Ð•ÑÐ»Ð¸ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ `club_drafts`, Ñ‚Ð¾:
- `pending TTL` Ð±ÐµÑ€Ñ‘Ð¼ Ð¸Ð· `billing_policy.pending_ttl_minutes`
- draft ÑƒÐ´Ð°Ð»ÑÐµÑ‚ÑÑ/Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ (Ð¿Ð¾ cron/Ñ€ÑƒÑ‡Ð½Ð¾Ð¼Ñƒ cleanup Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ)

---

## 6) Flow: Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‚Ð° / grace / expired (Ð²ÑÑ‘ Ð¸Ð· Ð‘Ð”)

### 6.1 Ð¡Ñ‚Ð°Ñ‚ÑƒÑ-Ð¼Ð°ÑˆÐ¸Ð½Ð°

```
active â†’ ÐµÑÐ»Ð¸ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»ÑÑ:
  â””â”€> ÐµÑÐ»Ð¸ Ð² policy ÐµÑÑ‚ÑŒ grace: grace + grace_until = period_end + grace_days
  
grace â†’ ÐµÑÐ»Ð¸ now() > grace_until:
  â””â”€> expired
  
pending â†’ ÐµÑÐ»Ð¸ Ð½Ðµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾ Ð¸ Ð¸ÑÑ‚Ñ‘Ðº TTL:
  â””â”€> failed payment + cleanup draft/intent
```

### 6.2 Ð§Ñ‚Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ

Backend Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸ Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°ÐµÑ‚:

1. **Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ ÐºÐ»ÑƒÐ±Ð°**
2. **Ð Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½ Ð»Ð¸ action** Ð² `billing_policy_actions` Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
3. **Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ð»Ð°Ð½Ð°** (`club_plans`)
4. **Ð”Ð¾Ð¿. Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸** (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ `current_member_count`, `requested_participants`)

---

## 7) Enforcement: ÐµÐ´Ð¸Ð½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸

### 7.1 ÐšÐ¾Ð½Ñ‚Ñ€Ð°ÐºÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸

```typescript
assertAllowed({ 
  scope: 'personal' | 'club',
  action: string,  // Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° actions
  clubId?: string,
  context?: {
    requestedEventParticipants?: number,
    currentClubMembers?: number,
    isPaidEvent?: boolean,
    isCsvExport?: boolean,
  }
})
```

### 7.2 ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ (Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹)

#### Ð”Ð»Ñ `club-scope`:

1. **Load** `club_subscriptions` by `club_id`
2. **Load** `club_plans` by `plan_id`
3. **Load** `billing_policy` + `billing_policy_actions` Ð´Ð»Ñ `policy_id='default'`
4. **If** `status != 'active'`:
   - check if action allowed by policy for this status
   - if not allowed â†’ **throw Paywall (402)**
5. **Apply plan limits:**
   - `max_members`
   - `max_event_participants`
   - `allow_paid_events`
   - `allow_csv_export`
6. **If violates** â†’ **throw Paywall (402)** Ñ required plan

#### Ð”Ð»Ñ `personal-scope`:

ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ **free-Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ** (hardcoded Ð¸Ð»Ð¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ `personal_plan_policy` Ð² Ð‘Ð” â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð·Ð¶Ðµ).

Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð¿Ñ€Ð¾Ñ‰Ðµ: `personal = Free-Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ`:
```typescript
{
  max_event_participants: 15,
  paid_events: false,
  csv_export: false,
}
```

---

## 8) Paywall: ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

Backend Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ **HTTP 402**:

```typescript
{
  "success": false,
  "error": {
    "code": "PAYWALL",
    "reason": "MAX_EVENT_PARTICIPANTS_EXCEEDED",
    "currentPlanId": "club_50",
    "requiredPlanId": "club_500",
    "meta": {
      "limit": 50,
      "requested": 120
    },
    "cta": {
      "type": "OPEN_PRICING",
      "href": "/pricing"
    }
  }
}
```

### Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ðµ `reason`:

```typescript
enum PaywallReason {
  CLUB_CREATION_REQUIRES_PLAN = 'CLUB_CREATION_REQUIRES_PLAN',
  SUBSCRIPTION_EXPIRED = 'SUBSCRIPTION_EXPIRED',
  PAID_EVENTS_NOT_ALLOWED = 'PAID_EVENTS_NOT_ALLOWED',
  CSV_EXPORT_NOT_ALLOWED = 'CSV_EXPORT_NOT_ALLOWED',
  MAX_EVENT_PARTICIPANTS_EXCEEDED = 'MAX_EVENT_PARTICIPANTS_EXCEEDED',
  MAX_CLUB_MEMBERS_EXCEEDED = 'MAX_CLUB_MEMBERS_EXCEEDED',
}
```

---

## 9) `/api/plans` (data source = Ð‘Ð”)

Endpoint `/api/plans` Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ `club_plans`:
- Ñ‚Ð¾Ð»ÑŒÐºÐ¾ `is_public = true`
- Ð¾Ñ‚Ð´Ð°Ñ‘Ñ‚ Ñ†ÐµÐ½Ñ‹/Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹/Ñ„Ð»Ð°Ð³Ð¸

**Free** Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ°Ðº Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½ (`id=free`), Ð½Ð¾:
- âŒ Ð½Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð² `club_plans`
- âœ… Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÐºÐ¾Ð´Ðµ ÐºÐ°Ðº Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚

Ð­Ñ‚Ð¾ ÑƒÐ´Ð¾Ð±Ð½Ð¾ Ð´Ð»Ñ UI pricing Ð¸ QA snapshot.

---

## 10) Ð§Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð¹ Ð±Ð°Ð·Ðµ

### 10.1 ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸

```
âœ… create_club_plans.sql
âœ… seed_club_plans.sql
âœ… create_billing_policy.sql
âœ… seed_billing_policy.sql
âœ… create_billing_policy_actions.sql
âœ… seed_billing_policy_actions.sql
âœ… create_club_subscriptions.sql
âœ… create_billing_transactions.sql
âœ… create_club_members.sql (ÐµÑÐ»Ð¸ Ð½ÐµÑ‚)
âœ… create_club_cities.sql
```

### 10.2 Repository ÑÐ»Ð¾Ð¹ (db)

**planRepo.ts:**
```typescript
listPublicPlans()
getPlanById(planId)
```

**billingPolicyRepo.ts:**
```typescript
getDefaultBillingPolicy()
getPolicyActions(policyId) // â†’ map status â†’ set(actions allowed)
```

**clubSubscriptionRepo.ts:**
```typescript
getClubSubscription(clubId)
setStatus(...)
activateSubscription(clubId, planId, periodStart, periodEnd, graceUntil)
```

**billingTransactionsRepo.ts:**
```typescript
createTransactionPending
markPaid
markFailed
```

### 10.3 Service ÑÐ»Ð¾Ð¹

**accessControl.ts** (Ð¸Ð»Ð¸ limits.ts):
```typescript
assertAllowed(...)
resolveRequiredPlanForEventParticipants(count)
resolveRequiredPlanForClubMembers(count)
```

**billingState.ts:**
```typescript
refreshSubscriptionStatusIfNeeded(clubId)
// Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¾Ð² + policy
// ÐÐ• Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð¾ Ñ‚ÑÐ¶ÐµÐ»Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑÑ‡Ñ‘Ñ‚Ñ‹ â€” ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ (in-request) Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾
```

### 10.4 API

**GET /api/plans**

Ð’ÑÐµ club endpoints Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ `assertAllowed`:
- create club â†’ paywall ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚Ð°Ñ€Ð¸Ñ„Ð°
- create club event
- export csv
- create paid event
- invite member

### 10.5 UI Ñ€ÐµÐ°ÐºÑ†Ð¸Ñ

- Ð¤Ñ€Ð¾Ð½Ñ‚ Ð»Ð¾Ð²Ð¸Ñ‚ `402` Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ **Paywall modal** / redirect `/pricing`
- Paywall modal Ð¸Ð¼ÐµÐµÑ‚ CTA Ð½Ð° `/pricing`

---

## 11) QA: Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸

ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð½Ð°Ð±Ð¾Ñ€:

âœ… **Free Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±:** 402 + reason `CLUB_CREATION_REQUIRES_PLAN`

âœ… **Free personal event >15 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²:** 402 + `requiredPlanId: club_50`

âœ… **Club 50 event 51 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº:** 402 + `requiredPlanId: club_500`

âœ… **Club subscription expired:** Ð»ÑŽÐ±Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ `CLUB_CREATE_EVENT`, `CSV_EXPORT`, `PAID_EVENT` â†’ 402 (ÐµÑÐ»Ð¸ policy Ð·Ð°Ð¿Ñ€ÐµÑ‰Ð°ÐµÑ‚)

âœ… **Grace period:** Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ñ‹/Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ñ‹ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ `billing_policy_actions`

âœ… **CSV export:**
- Free: 402
- Club 50+: ok

âœ… **Paid event:**
- Free: 402
- Club 50+: ok

---

## 12) ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ Ð¿Ð¾ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑŽ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹

(Ð±ÐµÐ· Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°)

- `billing_transactions` Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ ÑÑƒÐ¼Ð¼Ñ‹ Ð² **KZT**
- `club_plans.price_monthly_kzt` â€” ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ñ†ÐµÐ½Ñ‹
- `pending`/`paid`/`failed` ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð¼ webhook/ÐºÐ¾Ð»Ð±ÑÐºÐ° Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°

---

## 13) Ð˜Ñ‚Ð¾Ð³ (ÐºÑ€Ð°Ñ‚ÐºÐ°Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ°)

| Ð§Ñ‚Ð¾ | Ð“Ð´Ðµ |
|-----|-----|
| **Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹, Ñ†ÐµÐ½Ñ‹, Ñ„Ð¸Ñ‡Ð¸** | `club_plans` |
| **Grace/Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‚Ð° Ð¸ Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ** | `billing_policy` + `billing_policy_actions` |
| **Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ ÐºÐ»ÑƒÐ±Ð°** | `club_subscriptions` |
| **Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´ÐµÐ½ÐµÐ³** | `billing_transactions` |
| **Enforcement** | Ñ‚Ð¾Ð»ÑŒÐºÐ¾ backend Ñ‡ÐµÑ€ÐµÐ· `assertAllowed(...)` |
| **Free** | ÑÑ‚Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼ "Ð±ÐµÐ· ÐºÐ»ÑƒÐ±Ð°", ÐºÐ»ÑƒÐ± Ð½Ð° free Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ |

---

## 14) Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ñ ÐºÐ¾Ð´Ð°

```typescript
// Free limits (hardcoded, Ð½Ðµ Ð² Ð‘Ð”)
export const FREE_LIMITS = {
  maxEventParticipants: 15,
  allowPaidEvents: false,
  allowCsvExport: false,
} as const;

// Plan IDs
export const PLAN_IDS = ["club_50", "club_500", "unlimited"] as const;
export type PlanId = typeof PLAN_IDS[number];

// Subscription statuses
export const SUBSCRIPTION_STATUSES = ["pending", "active", "grace", "expired"] as const;
export type SubscriptionStatus = typeof SUBSCRIPTION_STATUSES[number];

// Helper: Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ required plan Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
export const REQUIRED_PLAN_FOR_PARTICIPANTS = (n: number): PlanId | 'free' => {
  if (n <= 15) return "free";
  if (n <= 50) return "club_50";
  if (n <= 500) return "club_500";
  return "unlimited";
};

// Helper: Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ required plan Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ Ñ‡Ð»ÐµÐ½Ð¾Ð² ÐºÐ»ÑƒÐ±Ð°
export const REQUIRED_PLAN_FOR_MEMBERS = (n: number): PlanId => {
  if (n <= 50) return "club_50";
  if (n <= 500) return "club_500";
  return "unlimited";
};
```

---

## ðŸ“Š ÐšÑ€Ð°Ñ‚ÐºÐ°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð²

| ÐŸÐ»Ð°Ð½ | Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸/ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ | Ð§Ð»ÐµÐ½Ñ‹ ÐºÐ»ÑƒÐ±Ð° | Paid events | CSV | Ð¦ÐµÐ½Ð° (KZT) |
|------|------------------|-------------|-------------|-----|-----------|
| **Free** | 15 | - | âŒ | âŒ | 0 |
| **Club 50** | 50 | 50 | âœ… | âœ… | 3 490 â‚¸/Ð¼ÐµÑ |
| **Club 500** | 500 | 500 | âœ… | âœ… | 11 990 â‚¸/Ð¼ÐµÑ |
| **Unlimited** | âˆž | âˆž | âœ… | âœ… | Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾ |

---

**Ð’ÐµÑ€ÑÐ¸Ñ:** 2.0  
**Ð”Ð°Ñ‚Ð°:** Ð”ÐµÐºÐ°Ð±Ñ€ÑŒ 2024  
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¸ÑÑ‚Ð¸Ð½Ñ‹ (Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
