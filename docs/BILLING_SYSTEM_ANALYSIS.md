# üí≥ –ê–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–ª–∏–Ω–≥–∞ Need4Trip

> **Living Document** ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã  
> **–í–µ—Ä—Å–∏—è:** 1.0  
> **–î–∞—Ç–∞:** 23 –¥–µ–∫–∞–±—Ä—è 2024  
> **–°—Ç–∞—Ç—É—Å:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (v2.0)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
4. [–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã](#—Ç–∞—Ä–∏—Ñ–Ω—ã–µ-–ø–ª–∞–Ω—ã)
5. [–°–∏—Å—Ç–µ–º–∞ enforcement](#—Å–∏—Å—Ç–µ–º–∞-enforcement)
6. [Paywall Modal](#paywall-modal)
7. [Flow —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è](#flow-—Å–æ–∑–¥–∞–Ω–∏—è-—Å–æ–±—ã—Ç–∏—è)
8. [–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã](#–∫–ª—é—á–µ–≤—ã–µ-—Ñ–∞–π–ª—ã)
9. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
10. [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
11. [–°—Ç–∞—Ç—É—Å-–º–∞—à–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏](#—Å—Ç–∞—Ç—É—Å-–º–∞—à–∏–Ω–∞-–ø–æ–¥–ø–∏—Å–∫–∏)
12. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
13. [–û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è](#–æ–±–ª–∞—Å—Ç–∏-–¥–ª—è-—É–ª—É—á—à–µ–Ω–∏—è)
14. [–ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è](#–ø–ª–∞–Ω-—Ä–∞–∑–≤–∏—Ç–∏—è)

---

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

–°–∏—Å—Ç–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞ Need4Trip –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö (—Å–æ–≥–ª–∞—Å–Ω–æ `docs/BILLING_AND_LIMITS.md`):

1. **Frontend –Ω–µ —Ä–µ—à–∞–µ—Ç –ª–∏–º–∏—Ç—ã –∏ –¥–æ—Å—Ç—É–ø** ‚Äî —Ñ—Ä–æ–Ω—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç UI –∏ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –æ—à–∏–±–∫–∏ backend
2. **Backend ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** ‚Äî –ø–æ –¥–æ—Å—Ç—É–ø—É, –ª–∏–º–∏—Ç–∞–º, grace –∏ paywall
3. **–¶–µ–Ω—ã –∏ –ª–∏–º–∏—Ç—ã ‚Äî –≤ –ë–î** ‚Äî seed + API `/api/plans`
4. **–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–ø–ª–∞—Ç–µ ‚Äî –≤ –ë–î** ‚Äî grace period, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ `pending`/`grace`/`expired`
5. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –¥–æ—Å—Ç—É–ø–∞** ‚Äî `billing_transactions` ‚Äî —Ç–æ–ª—å–∫–æ –∞—É–¥–∏—Ç/–∏—Å—Ç–æ—Ä–∏—è

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

| –¢–µ—Ä–º–∏–Ω | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| **User** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Telegram) |
| **Club** | –ü–ª–∞—Ç–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å (–≤ Free –∫–ª—É–± —Å–æ–∑–¥–∞—Ç—å –Ω–µ–ª—å–∑—è) |
| **Plan** | –¢–∞—Ä–∏—Ñ –∫–ª—É–±–∞ (`Club 50` / `Club 500` / `Unlimited`) |
| **Subscription** | –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –∫–ª—É–±–∞: `active`/`grace`/`expired`/`pending` |
| **Limits** | –õ–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–∞ (max_members, max_event_participants, paid events, CSV export) |
| **Actions** | –û–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω—ã/–∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ |
| **Billing policy** | –ü—Ä–∞–≤–∏–ª–∞ grace –∏ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ actions –ø—Ä–∏ pending/grace/expired |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        DATABASE (Supabase)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ  club_plans     ‚îÇ  ‚îÇ billing_policy  ‚îÇ  ‚îÇ billing_policy  ‚îÇ  ‚îÇ
‚îÇ ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ    _actions     ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - id            ‚îÇ  ‚îÇ - id            ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - title         ‚îÇ  ‚îÇ - grace_days    ‚îÇ  ‚îÇ - status        ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - price_kzt     ‚îÇ  ‚îÇ - pending_ttl   ‚îÇ  ‚îÇ - action        ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - max_members   ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ - is_allowed    ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - max_event_... ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - allow_paid    ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ
‚îÇ ‚îÇ - allow_csv     ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ ‚îÇ club_           ‚îÇ  ‚îÇ billing_transactions (audit)        ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  subscriptions  ‚îÇ  ‚îÇ                                     ‚îÇ   ‚îÇ
‚îÇ ‚îÇ                 ‚îÇ  ‚îÇ - id, club_id, plan_id              ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - club_id       ‚îÇ  ‚îÇ - provider, provider_payment_id     ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - plan_id       ‚îÇ  ‚îÇ - amount_kzt, currency              ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - status        ‚îÇ  ‚îÇ - status (pending/paid/failed)      ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - period_start  ‚îÇ  ‚îÇ - period_start, period_end          ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - period_end    ‚îÇ  ‚îÇ - created_at, updated_at            ‚îÇ   ‚îÇ
‚îÇ ‚îÇ - grace_until   ‚îÇ  ‚îÇ                                     ‚îÇ   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üë Query + Cache (5 min)
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     BACKEND (Repository Layer)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ planRepo.ts                 ‚Üí getPlanById(), listPublicPlans()   ‚îÇ
‚îÇ clubSubscriptionRepo.ts     ‚Üí getClubSubscription(), upsert...   ‚îÇ
‚îÇ billingPolicyRepo.ts        ‚Üí isActionAllowed(), getPolicyMap()  ‚îÇ
‚îÇ billingTransactionsRepo.ts  ‚Üí createPending(), markPaid()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üë
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     BACKEND (Service Layer)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ accessControl.ts            ‚Üí enforceClubAction()                ‚îÇ
‚îÇ   ‚îú‚îÄ enforceFreeLimit()     ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ FREE –ø–ª–∞–Ω–∞ –∏–∑ –ë–î          ‚îÇ
‚îÇ   ‚îú‚îÄ enforcePlanLimits()    ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–ª–∞–Ω–∞             ‚îÇ
‚îÇ   ‚îî‚îÄ getClubCurrentPlan()   ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üë throws PaywallError (402)
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      API ROUTES (Next.js)                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ POST /api/events            ‚Üí createEvent() ‚Üí enforceClubAction ‚îÇ
‚îÇ PUT  /api/events/[id]       ‚Üí updateEvent() ‚Üí enforceClubAction ‚îÇ
‚îÇ GET  /api/clubs/[id]/export ‚Üí enforceClubAction(CSV_EXPORT)     ‚îÇ
‚îÇ GET  /api/plans             ‚Üí listPublicPlans()                  ‚îÇ
‚îÇ GET  /api/clubs/[id]/plan   ‚Üí getClubCurrentPlan()               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üë HTTP 402 + PaywallError JSON
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FRONTEND (React/Next.js)                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PaywallModal (2 –≤–µ—Ä—Å–∏–∏)     ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è            ‚îÇ
‚îÇ useClubPlan()               ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ª–∏–º–∏—Ç—ã –¥–ª—è UI           ‚îÇ
‚îÇ usePaywall()                ‚Üí hook –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è paywall modal ‚îÇ
‚îÇ EventForm                   ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è + usePaywall()           ‚îÇ
‚îÇ PricingPage                 ‚Üí –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã –∏–∑ /api/plans   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph TB
    A[User Action] --> B[Frontend Component]
    B --> C[API Route]
    C --> D[Service Layer]
    D --> E{enforceClubAction}
    E --> F[Repository Layer]
    F --> G[(Database)]
    G --> F
    F --> E
    E -->|Access OK| D
    E -->|Access Denied| H[throw PaywallError]
    H --> C
    C --> I[respondError 402]
    I --> B
    B --> J[PaywallModal]
    J --> K[Redirect to /pricing]
```

---

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

#### 1. `club_plans` ‚Äî –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

```sql
CREATE TABLE public.club_plans (
  id TEXT PRIMARY KEY,                          -- 'free' | 'club_50' | 'club_500' | 'club_unlimited'
  title TEXT NOT NULL,
  
  price_monthly_kzt NUMERIC(10,2) NOT NULL,     -- –¶–µ–Ω–∞ –≤ —Ç–µ–Ω–≥–µ
  currency TEXT NOT NULL DEFAULT 'KZT',
  
  max_members INT NULL,                         -- NULL = –±–µ–∑–ª–∏–º–∏—Ç
  max_event_participants INT NULL,              -- NULL = –±–µ–∑–ª–∏–º–∏—Ç
  
  allow_paid_events BOOLEAN NOT NULL,
  allow_csv_export BOOLEAN NOT NULL,
  
  is_public BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_club_plans_public ON club_plans(is_public, price_monthly_kzt);
```

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `20241215_create_club_plans_v2.sql` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
- `20241215_seed_club_plans.sql` ‚Äî seed –ø–ª–∞–Ω–æ–≤ (Club 50, 500, Unlimited)
- `20241216_add_free_plan.sql` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ FREE –ø–ª–∞–Ω–∞ –≤ –ë–î

#### 2. `club_subscriptions` ‚Äî –ü–æ–¥–ø–∏—Å–∫–∏ –∫–ª—É–±–æ–≤

```sql
CREATE TABLE public.club_subscriptions (
  club_id UUID PRIMARY KEY REFERENCES clubs(id) ON DELETE CASCADE,
  
  plan_id TEXT NOT NULL REFERENCES club_plans(id),
  status TEXT NOT NULL CHECK (status IN ('pending', 'active', 'grace', 'expired')),
  
  current_period_start TIMESTAMPTZ NULL,
  current_period_end TIMESTAMPTZ NULL,
  
  grace_until TIMESTAMPTZ NULL,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_club_subscriptions_plan_id ON club_subscriptions(plan_id);
CREATE INDEX idx_club_subscriptions_status ON club_subscriptions(status);
CREATE INDEX idx_club_subscriptions_period_end ON club_subscriptions(current_period_end) 
  WHERE current_period_end IS NOT NULL;
```

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí FREE –ø–ª–∞–Ω (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –±–µ–∑ –∫–ª—É–±–∞)

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `20241212_create_club_subscriptions.sql` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
- `20241215_alter_club_subscriptions_v2_SAFE.sql` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ v2.0

#### 3. `billing_policy` ‚Äî –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞

```sql
CREATE TABLE public.billing_policy (
  id TEXT PRIMARY KEY,                           -- 'default'
  grace_period_days INT NOT NULL DEFAULT 7,      -- –î–Ω–µ–π grace –ø–µ—Ä–∏–æ–¥–∞
  pending_ttl_minutes INT NOT NULL DEFAULT 60,   -- –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Seed:** `grace_period_days = 7`, `pending_ttl_minutes = 60`

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `20241215_create_billing_policy.sql`
- `20241215_seed_billing_policy.sql`

#### 4. `billing_policy_actions` ‚Äî –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º

```sql
CREATE TABLE public.billing_policy_actions (
  policy_id TEXT NOT NULL REFERENCES billing_policy(id) ON DELETE CASCADE,
  status TEXT NOT NULL CHECK (status IN ('pending','grace','expired')),
  action TEXT NOT NULL,
  is_allowed BOOLEAN NOT NULL DEFAULT false,
  
  PRIMARY KEY (policy_id, status, action)
);
```

**Seed –¥–∞–Ω–Ω—ã–µ:**

| status | action | is_allowed |
|--------|--------|-----------|
| **grace** | CLUB_CREATE_EVENT | ‚úÖ true |
| **grace** | CLUB_UPDATE_EVENT | ‚úÖ true |
| **grace** | CLUB_CREATE_PAID_EVENT | ‚úÖ true |
| **grace** | CLUB_EXPORT_PARTICIPANTS_CSV | ‚úÖ true |
| **grace** | CLUB_INVITE_MEMBER | ‚úÖ true |
| **expired** | ALL_ACTIONS | ‚ùå false |
| **pending** | ALL_ACTIONS | ‚ùå false |

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `20241215_create_billing_policy_actions.sql`
- `20241215_seed_billing_policy_actions.sql`

#### 5. `billing_transactions` ‚Äî –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π (audit trail)

```sql
CREATE TABLE public.billing_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  plan_id TEXT NOT NULL REFERENCES club_plans(id),
  
  provider TEXT NOT NULL,                       -- 'kaspi' | 'epay' | 'manual'
  provider_payment_id TEXT,
  
  amount_kzt NUMERIC(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'KZT',
  
  status TEXT NOT NULL CHECK (status IN ('pending','paid','failed','refunded')),
  
  period_start TIMESTAMPTZ NULL,
  period_end TIMESTAMPTZ NULL,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_billing_transactions_club_id ON billing_transactions(club_id);
CREATE INDEX idx_billing_transactions_status ON billing_transactions(status);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ–ª—å–∫–æ –∞—É–¥–∏—Ç. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞.

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `20241215_create_billing_transactions.sql`

### RLS (Row Level Security)

**–í–∫–ª—é—á–µ–Ω–æ –¥–ª—è:**
- `club_subscriptions` ‚Äî `20241222_enable_rls_club_subscriptions.sql`
- `billing_transactions` ‚Äî `20241222_enable_rls_billing_transactions.sql`

---

## üí∞ –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### –¢–µ–∫—É—â–∏–µ –ø–ª–∞–Ω—ã

| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –¶–µ–Ω–∞/–º–µ—Å | –£—á–∞—Å—Ç–Ω–∏–∫–∏/—Å–æ–±—ã—Ç–∏–µ | –ß–ª–µ–Ω—ã –∫–ª—É–±–∞ | –ü–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è | CSV —ç–∫—Å–ø–æ—Ä—Ç |
|----|----------|----------|-------------------|-------------|-----------------|-------------|
| `free` | **Free** | 0 ‚Ç∏ | 15 | - | ‚ùå | ‚ùå |
| `club_50` | **Club 50** | 5,000 ‚Ç∏ | 50 | 50 | ‚úÖ | ‚úÖ |
| `club_500` | **Club 500** | 15,000 ‚Ç∏ | 500 | 500 | ‚úÖ | ‚úÖ |
| `club_unlimited` | **Unlimited** | 30,000 ‚Ç∏ | ‚àû | ‚àû | ‚úÖ | ‚úÖ |

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ FREE –ø–ª–∞–Ω–∞

**Free ‚Äî —ç—Ç–æ –Ω–µ –∫–ª—É–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ:**
- ‚ùå –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±
- ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –∫–ª—É–±—É)
- ‚úÖ –¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –õ–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 15
- ‚ùå CSV —ç–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–í –ë–î:** FREE –ø–ª–∞–Ω —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `club_plans` (—Å –≤–µ—Ä—Å–∏–∏ 2.1) –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ò—Å—Ç–æ—á–Ω–∏–∫ —Ç–∞—Ä–∏—Ñ–æ–≤

**Endpoint:** `GET /api/plans`

```typescript
// src/app/api/plans/route.ts
export async function GET() {
  const plans = await listPublicPlans(); // –í—Å–µ –ø–ª–∞–Ω—ã —Å is_public = true
  return NextResponse.json({
    success: true,
    data: { plans },
  });
}
```

**Frontend:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/pricing` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–ª–∞–Ω—ã –∏–∑ —ç—Ç–æ–≥–æ API.

---

## üîê –°–∏—Å—Ç–µ–º–∞ enforcement

### –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

**–§–∞–π–ª:** `src/lib/services/accessControl.ts`

```typescript
export async function enforceClubAction(params: {
  clubId: string;
  action: BillingActionCode;
  context?: {
    eventParticipantsCount?: number;
    clubMembersCount?: number;
    isPaidEvent?: boolean;
  };
}): Promise<void>
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)

```
1. Load club_subscriptions by club_id
2. If NULL ‚Üí FREE plan
   - Load FREE plan from DB (cached)
   - Check FREE limits
   - Throw PaywallError if violated
3. If subscription exists:
   a. Load plan from DB (cached)
   b. Check status:
      - active ‚Üí check plan limits only
      - grace/pending/expired ‚Üí check billing_policy_actions + limits
   c. If action not allowed ‚Üí throw PaywallError
   d. Check plan limits (max_members, max_event_participants, etc.)
   e. If limits exceeded ‚Üí throw PaywallError
```

### –ö–æ–¥—ã –¥–µ–π—Å—Ç–≤–∏–π (BillingActionCode)

```typescript
// src/lib/types/billing.ts
export const BILLING_ACTION_CODES = [
  "CLUB_CREATE_EVENT",
  "CLUB_UPDATE_EVENT",
  "CLUB_CREATE_PAID_EVENT",
  "CLUB_EXPORT_PARTICIPANTS_CSV",
  "CLUB_INVITE_MEMBER",
  "CLUB_REMOVE_MEMBER",
  "CLUB_UPDATE",
] as const;
```

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä–æ–∫

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

```typescript
// src/lib/services/accessControl.ts (enforcePlanLimits)
if (plan.maxEventParticipants !== null && 
    context.eventParticipantsCount > plan.maxEventParticipants) {
  
  const requiredPlan = await getRequiredPlanForParticipants(
    context.eventParticipantsCount
  );
  
  throw new PaywallError({
    message: `Event with ${context.eventParticipantsCount} participants exceeds limit`,
    reason: "MAX_EVENT_PARTICIPANTS_EXCEEDED",
    currentPlanId: plan.id,
    requiredPlanId: requiredPlan,
    meta: {
      requested: context.eventParticipantsCount,
      limit: plan.maxEventParticipants,
    },
  });
}
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ CSV —ç–∫—Å–ø–æ—Ä—Ç–∞

```typescript
if (action === "CLUB_EXPORT_PARTICIPANTS_CSV") {
  if (!plan.allowCsvExport) {
    throw new PaywallError({
      message: "CSV export not allowed on your plan",
      reason: "CSV_EXPORT_NOT_ALLOWED",
      currentPlanId: plan.id,
      requiredPlanId: "club_50",
    });
  }
}
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```typescript
// –ï—Å–ª–∏ status != 'active'
const isAllowed = await isActionAllowed(subscription.status, action);

if (!isAllowed) {
  throw new PaywallError({
    message: `Action "${action}" not allowed for status "${subscription.status}"`,
    reason: "SUBSCRIPTION_NOT_ACTIVE",
    currentPlanId: subscription.planId,
    meta: { status: subscription.status },
  });
}
```

### PaywallError —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```typescript
// src/lib/errors.ts
export class PaywallError extends AppError {
  reason: string;
  currentPlanId?: string;
  requiredPlanId?: string;
  meta?: Record<string, unknown>;
  cta: {
    type: "OPEN_PRICING";
    href: "/pricing";
  };
  
  // statusCode: 402
  // code: "PAYWALL"
}
```

**–ü—Ä–∏—á–∏–Ω—ã paywall (reason codes):**

```typescript
export const PAYWALL_REASONS = [
  "CLUB_CREATION_REQUIRES_PLAN",
  "SUBSCRIPTION_EXPIRED",
  "SUBSCRIPTION_NOT_ACTIVE",
  "PAID_EVENTS_NOT_ALLOWED",
  "CSV_EXPORT_NOT_ALLOWED",
  "MAX_EVENT_PARTICIPANTS_EXCEEDED",
  "MAX_CLUB_MEMBERS_EXCEEDED",
] as const;
```

---

## üöß Paywall Modal

### –î–≤–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è)

#### 1. PaywallModal.tsx (–Ω–æ–≤—ã–π, —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

**–§–∞–π–ª:** `src/components/billing/PaywallModal.tsx`

```typescript
interface PaywallModalProps {
  open: boolean;
  onClose: () => void;
  error: PaywallError; // –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
}

export function PaywallModal({ open, onClose, error }: PaywallModalProps) {
  const message = REASON_MESSAGES[error.reason] || defaultMessage;
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{message.title}</DialogTitle>
          <DialogDescription>{message.description}</DialogDescription>
        </DialogHeader>
        
        <div>
          {error.currentPlanId && <p>–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω: {error.currentPlanId}</p>}
          {error.requiredPlanId && <p>–¢—Ä–µ–±—É–µ—Ç—Å—è: {error.requiredPlanId}</p>}
          {error.meta && <p>–õ–∏–º–∏—Ç: {error.meta.limit} / –ó–∞–ø—Ä–æ—à–µ–Ω–æ: {error.meta.requested}</p>}
        </div>
        
        <DialogFooter>
          <Button onClick={() => router.push(error.cta.href)}>
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞—Ä–∏—Ñ—ã
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// Hook –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
export function usePaywall() {
  const [paywallError, setPaywallError] = useState<PaywallError | null>(null);
  
  const showPaywall = (error: PaywallError) => setPaywallError(error);
  const hidePaywall = () => setPaywallError(null);
  
  const PaywallModalComponent = paywallError ? (
    <PaywallModal open={!!paywallError} onClose={hidePaywall} error={paywallError} />
  ) : null;
  
  return { showPaywall, hidePaywall, PaywallModalComponent };
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
const { showPaywall, PaywallModalComponent } = usePaywall();

try {
  await createEvent(...);
} catch (err) {
  if (err.response?.status === 402) {
    showPaywall(err.response.data.error.details);
  }
}

return <>{PaywallModalComponent}</>;
```

#### 2. paywall-modal.tsx (—Å—Ç–∞—Ä—ã–π, —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)

**–§–∞–π–ª:** `src/components/billing/paywall-modal.tsx`

```typescript
interface PaywallModalProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  message: string;
  requiredPlanId?: string;
}

export function PaywallModal({
  isOpen,
  onClose,
  title = "–û–±–Ω–æ–≤–∏—Ç–µ —Ç–∞—Ä–∏—Ñ",
  message,
  requiredPlanId,
}: PaywallModalProps) {
  // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ PaywallError
}
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `src/components/events/create-event-page-content.tsx` (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)

### –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
const REASON_MESSAGES: Record<string, { title: string; description: string }> = {
  PAID_EVENTS_NOT_ALLOWED: {
    title: "–ü–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã",
    description: "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞–Ω Club 50 –∏–ª–∏ –≤—ã—à–µ.",
  },
  CSV_EXPORT_NOT_ALLOWED: {
    title: "CSV —ç–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    description: "–≠–∫—Å–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ CSV —Ç—Ä–µ–±—É–µ—Ç –ø–ª–∞–Ω Club 50 –∏–ª–∏ –≤—ã—à–µ.",
  },
  MAX_EVENT_PARTICIPANTS_EXCEEDED: {
    title: "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
    description: "–í–∞—à —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∞–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.",
  },
  MAX_CLUB_MEMBERS_EXCEEDED: {
    title: "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤",
    description: "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ –ø–ª–∞–Ω–∞.",
  },
  SUBSCRIPTION_EXPIRED: {
    title: "–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞",
    description: "–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–ª–∏—Ç–µ –µ—ë –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.",
  },
  CLUB_CREATION_REQUIRES_PLAN: {
    title: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω",
    description: "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω.",
  },
};
```

---

## üîÑ Flow —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è

### –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

```mermaid
sequenceDiagram
    participant U as User
    participant FE as Frontend
    participant API as POST /api/events
    participant SVC as events.ts::createEvent()
    participant AC as enforceClubAction()
    participant DB as Database

    U->>FE: –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ (30 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, Club 50)
    FE->>API: POST {clubId, maxParticipants: 30}
    API->>SVC: createEvent(payload, currentUser)
    SVC->>AC: enforceClubAction(clubId, "CLUB_CREATE_EVENT", {eventParticipantsCount: 30})
    AC->>DB: getClubSubscription(clubId)
    DB-->>AC: {planId: "club_50", status: "active"}
    AC->>DB: getPlanById("club_50")
    DB-->>AC: {maxEventParticipants: 50, ...}
    AC->>AC: Check: 30 <= 50 ‚úÖ
    AC-->>SVC: OK
    SVC->>DB: INSERT INTO events
    DB-->>SVC: Event created
    SVC-->>API: event object
    API-->>FE: 201 {success: true, data: {event}}
    FE-->>U: ‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π —Å Paywall

```mermaid
sequenceDiagram
    participant U as User
    participant FE as Frontend
    participant API as POST /api/events
    participant SVC as events.ts::createEvent()
    participant AC as enforceClubAction()
    participant DB as Database

    U->>FE: –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ (100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, Club 50)
    FE->>API: POST {clubId, maxParticipants: 100}
    API->>SVC: createEvent(payload, currentUser)
    SVC->>AC: enforceClubAction(clubId, "CLUB_CREATE_EVENT", {eventParticipantsCount: 100})
    AC->>DB: getClubSubscription(clubId)
    DB-->>AC: {planId: "club_50", status: "active"}
    AC->>DB: getPlanById("club_50")
    DB-->>AC: {maxEventParticipants: 50}
    AC->>AC: Check: 100 > 50 ‚ùå
    AC->>AC: getRequiredPlanForParticipants(100)
    AC-->>SVC: throw PaywallError({reason: "MAX_EVENT_PARTICIPANTS_EXCEEDED", requiredPlanId: "club_500"})
    SVC-->>API: PaywallError
    API->>API: respondError(PaywallError)
    API-->>FE: 402 {success: false, error: {code: "PAYWALL", details: {...}}}
    FE->>FE: showPaywall(error.details)
    FE-->>U: üöß PaywallModal: "–¢—Ä–µ–±—É–µ—Ç—Å—è Club 500"
    U->>FE: –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞—Ä–∏—Ñ—ã"
    FE-->>U: redirect to /pricing
```

### –ö–æ–¥ –≤ createEvent()

```typescript
// src/lib/services/events.ts
export async function createEvent(input: unknown, currentUser: CurrentUser | null) {
  const validated = EventCreateSchema.parse(input);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞ v2.0
  if (validated.clubId) {
    await enforceClubAction({
      clubId: validated.clubId,
      action: validated.isPaid ? "CLUB_CREATE_PAID_EVENT" : "CLUB_CREATE_EVENT",
      context: {
        eventParticipantsCount: validated.maxParticipants ?? undefined,
        isPaidEvent: validated.isPaid,
      },
    });
  } else {
    // Personal events (FREE plan)
    const freePlan = await getPlanById("free");
    
    if (validated.isPaid && !freePlan.allowPaidEvents) {
      throw new PaywallError({
        message: "–ü–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö",
        reason: "PAID_EVENTS_NOT_ALLOWED",
        currentPlanId: "free",
        requiredPlanId: "club_50",
      });
    }
    
    if (validated.maxParticipants && freePlan.maxEventParticipants !== null && 
        validated.maxParticipants > freePlan.maxEventParticipants) {
      throw new PaywallError({
        message: `–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (${validated.maxParticipants} > ${freePlan.maxEventParticipants})`,
        reason: "MAX_EVENT_PARTICIPANTS_EXCEEDED",
        currentPlanId: "free",
        requiredPlanId: "club_50",
        meta: {
          requested: validated.maxParticipants,
          limit: freePlan.maxEventParticipants,
        },
      });
    }
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ë–î
  const event = await createEventRecord({...validated, createdByUserId: currentUser.id});
  return event;
}
```

---

## üìÅ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

### Backend

#### Repository Layer (Database)

```
src/lib/db/
‚îú‚îÄ‚îÄ planRepo.ts                     ‚Äî –¢–∞—Ä–∏—Ñ—ã (—Å –∫—ç—à–µ–º)
‚îÇ   ‚îú‚îÄ‚îÄ listPublicPlans()
‚îÇ   ‚îú‚îÄ‚îÄ getPlanById()
‚îÇ   ‚îú‚îÄ‚îÄ getRequiredPlanForParticipants()
‚îÇ   ‚îî‚îÄ‚îÄ getRequiredPlanForMembers()
‚îÇ
‚îú‚îÄ‚îÄ clubSubscriptionRepo.ts         ‚Äî –ü–æ–¥–ø–∏—Å–∫–∏ –∫–ª—É–±–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ getClubSubscription()
‚îÇ   ‚îú‚îÄ‚îÄ upsertClubSubscription()
‚îÇ   ‚îú‚îÄ‚îÄ setClubSubscriptionStatus()
‚îÇ   ‚îî‚îÄ‚îÄ activateSubscription()
‚îÇ
‚îú‚îÄ‚îÄ billingPolicyRepo.ts            ‚Äî –ü–æ–ª–∏—Ç–∏–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ getDefaultBillingPolicy()
‚îÇ   ‚îú‚îÄ‚îÄ getPolicyActionsMap()
‚îÇ   ‚îî‚îÄ‚îÄ isActionAllowed()
‚îÇ
‚îî‚îÄ‚îÄ billingTransactionsRepo.ts      ‚Äî –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
    ‚îú‚îÄ‚îÄ createPendingTransaction()
    ‚îú‚îÄ‚îÄ markTransactionPaid()
    ‚îú‚îÄ‚îÄ markTransactionFailed()
    ‚îî‚îÄ‚îÄ getClubTransactions()
```

#### Service Layer (Business Logic)

```
src/lib/services/
‚îú‚îÄ‚îÄ accessControl.ts                ‚Äî Enforcement —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ enforceClubAction()         ‚Üê –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ enforceFreeLimit()
‚îÇ   ‚îú‚îÄ‚îÄ enforcePlanLimits()
‚îÇ   ‚îî‚îÄ‚îÄ getClubCurrentPlan()
‚îÇ
‚îú‚îÄ‚îÄ events.ts                       ‚Äî –õ–æ–≥–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ createEvent()               ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç enforceClubAction()
‚îÇ   ‚îî‚îÄ‚îÄ updateEvent()               ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç enforceClubAction()
‚îÇ
‚îî‚îÄ‚îÄ clubs.ts                        ‚Äî –õ–æ–≥–∏–∫–∞ –∫–ª—É–±–æ–≤
```

#### API Routes

```
src/app/api/
‚îú‚îÄ‚îÄ plans/
‚îÇ   ‚îî‚îÄ‚îÄ route.ts                    ‚Äî GET /api/plans
‚îÇ
‚îú‚îÄ‚îÄ clubs/[id]/
‚îÇ   ‚îú‚îÄ‚îÄ route.ts                    ‚Äî GET, PATCH /api/clubs/:id
‚îÇ   ‚îú‚îÄ‚îÄ current-plan/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts                ‚Äî GET /api/clubs/:id/current-plan
‚îÇ   ‚îî‚îÄ‚îÄ export/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts                ‚Äî GET /api/clubs/:id/export (CSV)
‚îÇ
‚îî‚îÄ‚îÄ events/
    ‚îú‚îÄ‚îÄ route.ts                    ‚Äî GET, POST /api/events
    ‚îî‚îÄ‚îÄ [id]/
        ‚îî‚îÄ‚îÄ route.ts                ‚Äî GET, PUT /api/events/:id
```

#### Errors & Response Handling

```
src/lib/
‚îú‚îÄ‚îÄ errors.ts                       ‚Äî PaywallError, AppError
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ response.ts                 ‚Äî respondError(), respondSuccess()
```

#### Types

```
src/lib/types/
‚îî‚îÄ‚îÄ billing.ts                      ‚Äî –í—Å–µ —Ç–∏–ø—ã –±–∏–ª–ª–∏–Ω–≥–∞
    ‚îú‚îÄ‚îÄ PlanId, ClubPlan
    ‚îú‚îÄ‚îÄ SubscriptionStatus, ClubSubscription
    ‚îú‚îÄ‚îÄ BillingActionCode
    ‚îú‚îÄ‚îÄ PaywallError, PaywallReason
    ‚îî‚îÄ‚îÄ BillingTransaction
```

### Frontend

#### Components

```
src/components/
‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îú‚îÄ‚îÄ PaywallModal.tsx            ‚Äî –ù–æ–≤—ã–π paywall modal (—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ paywall-modal.tsx           ‚Äî –°—Ç–∞—Ä—ã–π paywall modal (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
‚îÇ
‚îú‚îÄ‚îÄ events/
‚îÇ   ‚îú‚îÄ‚îÄ event-form.tsx              ‚Äî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç useClubPlan(), usePaywall()
‚îÇ   ‚îî‚îÄ‚îÄ create-event-page-content.tsx
‚îÇ
‚îî‚îÄ‚îÄ pricing/
    ‚îî‚îÄ‚îÄ pricing-card-button.tsx
```

#### Hooks

```
src/hooks/
‚îî‚îÄ‚îÄ use-club-plan.ts                ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞ –∫–ª—É–±–∞ –¥–ª—è UI
    ‚îî‚îÄ‚îÄ useClubPlan(clubId)
        ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç /api/clubs/:id/current-plan
        ‚îú‚îÄ‚îÄ –î–ª—è FREE: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–ª–∞–Ωviz –∏–∑ –ë–î (getPlanById("free"))
        ‚îî‚îÄ‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {plan, limits, loading, error}
```

#### Pages

```
src/app/(app)/
‚îú‚îÄ‚îÄ pricing/
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
‚îÇ
‚îî‚îÄ‚îÄ events/
    ‚îú‚îÄ‚îÄ create/
    ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
    ‚îî‚îÄ‚îÄ [id]/
        ‚îî‚îÄ‚îÄ edit/
            ‚îî‚îÄ‚îÄ page.tsx
```

### Database

```
supabase/migrations/
‚îú‚îÄ‚îÄ 20241215_create_club_plans_v2.sql
‚îú‚îÄ‚îÄ 20241215_seed_club_plans.sql
‚îú‚îÄ‚îÄ 20241216_add_free_plan.sql
‚îú‚îÄ‚îÄ 20241212_create_club_subscriptions.sql
‚îú‚îÄ‚îÄ 20241215_alter_club_subscriptions_v2_SAFE.sql
‚îú‚îÄ‚îÄ 20241215_create_billing_policy.sql
‚îú‚îÄ‚îÄ 20241215_seed_billing_policy.sql
‚îú‚îÄ‚îÄ 20241215_create_billing_policy_actions.sql
‚îú‚îÄ‚îÄ 20241215_seed_billing_policy_actions.sql
‚îú‚îÄ‚îÄ 20241215_create_billing_transactions.sql
‚îú‚îÄ‚îÄ 20241222_enable_rls_club_subscriptions.sql
‚îî‚îÄ‚îÄ 20241222_enable_rls_billing_transactions.sql
```

### Documentation

```
docs/
‚îú‚îÄ‚îÄ BILLING_AND_LIMITS.md           ‚Äî –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (source of truth)
‚îî‚îÄ‚îÄ BILLING_SYSTEM_ANALYSIS.md      ‚Äî –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑)
```

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è

```typescript
// src/lib/services/events.ts
export async function createEvent(input: unknown, currentUser: CurrentUser | null) {
  const validated = EventCreateSchema.parse(input);
  
  if (validated.clubId) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫–ª—É–±–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    await enforceClubAction({
      clubId: validated.clubId,
      action: validated.isPaid ? "CLUB_CREATE_PAID_EVENT" : "CLUB_CREATE_EVENT",
      context: {
        eventParticipantsCount: validated.maxParticipants ?? undefined,
        isPaidEvent: validated.isPaid,
      },
    });
  } else {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (FREE)
    const freePlan = await getPlanById("free");
    
    if (validated.isPaid && !freePlan.allowPaidEvents) {
      throw new PaywallError({...});
    }
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
  const event = await createEventRecord({...});
  return event;
}
```

### 2. CSV —ç–∫—Å–ø–æ—Ä—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –±–∏–ª–ª–∏–Ω–≥–∞

```typescript
// src/app/api/clubs/[id]/export/route.ts
export async function GET(req: NextRequest, { params }: Params) {
  const { id: clubId } = await params;
  const user = await getCurrentUserFromMiddleware(req);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
  const userRole = await getUserClubRole(user.id, clubId);
  if (userRole !== "owner" && userRole !== "organizer") {
    throw new ForbiddenError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞");
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞
  await enforceClubAction({
    clubId,
    action: "CLUB_EXPORT_PARTICIPANTS_CSV",
  });
  
  // –≠–∫—Å–ø–æ—Ä—Ç
  const members = await listMembers(clubId);
  const csv = generateCSV(members);
  
  return new NextResponse(csv, {
    headers: {
      "Content-Type": "text/csv",
      "Content-Disposition": `attachment; filename="members.csv"`,
    },
  });
}
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ useClubPlan –≤ —Ñ–æ—Ä–º–µ

```typescript
// src/components/events/event-form.tsx
export function EventForm({ club, ...props }) {
  const { plan, limits, loading } = useClubPlan(club?.id);
  const { showPaywall, PaywallModalComponent } = usePaywall();
  
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç –∏–∑ –ø–ª–∞–Ω–∞ (–∏–ª–∏ 15 –¥–ª—è FREE)
  const maxAllowedParticipants = limits?.maxEventParticipants ?? 15;
  
  const handleSubmit = async (data) => {
    try {
      await createEvent(data);
    } catch (err) {
      if (err.response?.status === 402) {
        showPaywall(err.response.data.error.details);
        return;
      }
      throw err;
    }
  };
  
  return (
    <>
      <form onSubmit={handleSubmit}>
        <Input
          label="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
          max={maxAllowedParticipants}
          hint={`–í–∞—à –ø–ª–∞–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ ${maxAllowedParticipants} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`}
        />
        <Button type="submit">–°–æ–∑–¥–∞—Ç—å</Button>
      </form>
      
      {PaywallModalComponent}
    </>
  );
}
```

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞ –∫–ª—É–±–∞

```typescript
// src/app/api/clubs/[id]/current-plan/route.ts
export async function GET(req: NextRequest, { params }: Params) {
  const { id: clubId } = await params;
  const user = await getCurrentUserFromMiddleware(req);
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —á–µ—Ä–µ–∑ service
  const { planId, plan, subscription } = await getClubCurrentPlan(clubId);
  
  return respondSuccess({
    planId: plan.id,
    planTitle: plan.title,
    subscription: subscription ? {
      status: subscription.status,
      currentPeriodStart: subscription.currentPeriodStart,
      currentPeriodEnd: subscription.currentPeriodEnd,
      graceUntil: subscription.graceUntil,
    } : null,
    limits: {
      maxMembers: plan.maxMembers,
      maxEventParticipants: plan.maxEventParticipants,
      allowPaidEvents: plan.allowPaidEvents,
      allowCsvExport: plan.allowCsvExport,
    },
  });
}
```

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ PaywallError –≤ API

```typescript
// src/lib/api/response.ts
export function respondError(error: AppError | Error | unknown) {
  // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è PaywallError
  if (isPaywallError(error)) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: error.code,              // "PAYWALL"
          message: error.message,
          details: error.toJSON(),       // –ü–æ–ª–Ω—ã–π payload
        },
      },
      { status: 402 }
    );
  }
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
  if (isAppError(error)) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: error.code,
          message: error.message,
          details: error.details,
        },
      },
      { status: error.statusCode }
    );
  }
  
  return NextResponse.json({ error: "Internal Error" }, { status: 500 });
}
```

---

## ‚ö° –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### StaticCache –¥–ª—è –ø–ª–∞–Ω–æ–≤

**–§–∞–π–ª:** `src/lib/cache/staticCache.ts`  
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** `src/lib/db/planRepo.ts`

```typescript
const plansCache = new StaticCache<ClubPlan>(
  {
    ttl: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    name: 'club_plans',
  },
  async () => {
    // Loader: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –ø–ª–∞–Ω—ã –∏–∑ –ë–î
    const { data } = await supabase
      .from('club_plans')
      .select('*')
      .order('price_monthly_kzt', { ascending: true });
    
    return data.map(mapDbPlanToDomain);
  },
  (plan) => plan.id // Key extractor
);

// –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à
export async function getPlanById(planId: PlanId): Promise<ClubPlan> {
  const plan = await plansCache.getByKey(planId); // O(1)
  if (!plan) throw new NotFoundError(`Plan '${planId}' not found`);
  return plan;
}

export async function listPublicPlans(): Promise<ClubPlan[]> {
  const allPlans = await plansCache.getAll();
  return allPlans.filter(plan => plan.isPublic);
}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **O(1) –¥–æ—Å—Ç—É–ø** –ø–æ –∫–ª—é—á—É (planId)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** —á–µ—Ä–µ–∑ TTL
- ‚úÖ **–ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏** ‚Äî –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î –Ω–∞ 5 –º–∏–Ω—É—Ç
- ‚úÖ **FREE –ø–ª–∞–Ω —Ç–µ–ø–µ—Ä—å –≤ –∫—ç—à–µ** ‚Äî —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –ø–ª–∞—Ç–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏

### –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

```typescript
export async function invalidatePlansCache(): Promise<void> {
  plansCache.clear();
  log.info("Club plans cache invalidated");
}
```

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ —á–µ—Ä–µ–∑ admin API (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω).

---

## üîÑ –°—Ç–∞—Ç—É—Å-–º–∞—à–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

```mermaid
stateDiagram-v2
    [*] --> pending: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞
    pending --> active: –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
    pending --> [*]: TTL –∏—Å—Ç—ë–∫ (60 –º–∏–Ω)
    
    active --> grace: –ü–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç—ë–∫
    grace --> active: –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–æ
    grace --> expired: Grace –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç—ë–∫
    
    expired --> active: –û–ø–ª–∞—Ç–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞
    expired --> [*]: –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—É–±–∞
```

### –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

| –°—Ç–∞—Ç—É—Å | –ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è | –ü–µ—Ä–µ—Ö–æ–¥ |
|--------|----------------------|---------------------|---------|
| **pending** | Payment intent —Å–æ–∑–¥–∞–Ω, –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è | ‚ùå –ù–∏—á–µ–≥–æ (–∫—Ä–æ–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) | ‚Üí `active` (payment confirmed) <br> ‚Üí deleted (TTL expired) |
| **active** | –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞, –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ | ‚úÖ –í—Å—ë (–≤ —Ä–∞–º–∫–∞—Ö –ª–∏–º–∏—Ç–æ–≤ –ø–ª–∞–Ω–∞) | ‚Üí `grace` (period_end reached) |
| **grace** | –ü–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç—ë–∫, –Ω–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç grace | ‚úÖ –ü–æ—á—Ç–∏ –≤—Å—ë (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è) | ‚Üí `active` (renewal paid) <br> ‚Üí `expired` (grace_until reached) |
| **expired** | Grace –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç—ë–∫, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ | ‚ùå Read-only | ‚Üí `active` (payment) <br> ‚Üí deleted (manual) |

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ billing_policy

```sql
SELECT * FROM billing_policy WHERE id = 'default';

-- id: 'default'
-- grace_period_days: 7
-- pending_ttl_minutes: 60
```

**Grace period:** 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è `current_period_end`

**Pending TTL:** 60 –º–∏–Ω—É—Ç –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (TODO)

**–°–µ–π—á–∞—Å:** –ü–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ API.

**–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è:** Cron job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:
- `active` ‚Üí `grace` (–∫–æ–≥–¥–∞ `current_period_end < now()`)
- `grace` ‚Üí `expired` (–∫–æ–≥–¥–∞ `grace_until < now()`)
- `pending` ‚Üí cleanup (–∫–æ–≥–¥–∞ `created_at + pending_ttl < now()`)

---

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### Backend: respondError()

```typescript
// src/lib/api/response.ts
export function respondError(error: AppError | Error | unknown) {
  // 1. PaywallError ‚Üí 402
  if (isPaywallError(error)) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: "PAYWALL",
          message: error.message,
          details: {
            reason: error.reason,
            currentPlanId: error.currentPlanId,
            requiredPlanId: error.requiredPlanId,
            meta: error.meta,
            cta: { type: "OPEN_PRICING", href: "/pricing" },
          },
        },
      },
      { status: 402 }
    );
  }
  
  // 2. –î—Ä—É–≥–∏–µ AppError
  if (isAppError(error)) {
    return NextResponse.json(
      { success: false, error: {...} },
      { status: error.statusCode }
    );
  }
  
  // 3. –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
  return NextResponse.json(
    { success: false, error: { code: "InternalError", message: "..." } },
    { status: 500 }
  );
}
```

### Frontend: –æ–±—Ä–∞–±–æ—Ç–∫–∞ 402

```typescript
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
const { showPaywall, PaywallModalComponent } = usePaywall();

const handleSubmit = async (data) => {
  try {
    const response = await fetch('/api/events', {
      method: 'POST',
      body: JSON.stringify(data),
    });
    
    if (!response.ok) {
      if (response.status === 402) {
        const json = await response.json();
        showPaywall(json.error.details);
        return;
      }
      throw new Error('Server error');
    }
    
    const result = await response.json();
    // Success handling
  } catch (err) {
    // Error handling
  }
};

return (
  <>
    <form onSubmit={handleSubmit}>...</form>
    {PaywallModalComponent}
  </>
);
```

### PaywallError JSON format

**Response body –ø—Ä–∏ 402:**

```json
{
  "success": false,
  "error": {
    "code": "PAYWALL",
    "message": "Event with 100 participants exceeds your plan limit of 50",
    "details": {
      "reason": "MAX_EVENT_PARTICIPANTS_EXCEEDED",
      "currentPlanId": "club_50",
      "requiredPlanId": "club_500",
      "meta": {
        "requested": 100,
        "limit": 50
      },
      "cta": {
        "type": "OPEN_PRICING",
        "href": "/pricing"
      }
    }
  }
}
```

---

## üîç –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è PaywallModal

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–µ –≤–µ—Ä—Å–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏.

**–§–∞–π–ª—ã:**
- `src/components/billing/PaywallModal.tsx` ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
- `src/components/billing/paywall-modal.tsx` ‚Äî —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ `PaywallModal.tsx`
- [ ] –£–¥–∞–ª–∏—Ç—å `paywall-modal.tsx`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `create-event-page-content.tsx`

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
```
src/components/events/create-event-page-content.tsx
```

---

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–µ—Ö–æ–¥—ã `active ‚Üí grace ‚Üí expired` –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

**–°–µ–π—á–∞—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –°–æ–∑–¥–∞—Ç—å cron endpoint `/api/cron/billing-status-update`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Vercel Cron (–∏–ª–∏ –≤–Ω–µ—à–Ω–∏–π scheduler)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É:
  ```typescript
  // –ü—Å–µ–≤–¥–æ–∫–æ–¥
  async function updateExpiredSubscriptions() {
    const policy = await getDefaultBillingPolicy();
    
    // active ‚Üí grace
    const activeExpired = await findSubscriptions({
      status: 'active',
      where: 'current_period_end < now()',
    });
    
    for (const sub of activeExpired) {
      const graceUntil = addDays(sub.currentPeriodEnd, policy.gracePeriodDays);
      await setClubSubscriptionStatus(sub.clubId, 'grace', graceUntil);
    }
    
    // grace ‚Üí expired
    const graceExpired = await findSubscriptions({
      status: 'grace',
      where: 'grace_until < now()',
    });
    
    for (const sub of graceExpired) {
      await setClubSubscriptionStatus(sub.clubId, 'expired', null);
    }
  }
  ```

**–ß–∞—Å—Ç–æ—Ç–∞:** –ö–∞–∂–¥—ã–π —á–∞—Å –∏–ª–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π).

---

### 3. –ü–ª–∞—Ç—ë–∂–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Kaspi, ePay, Stripe)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, –Ω–æ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `billing_transactions` —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ Repository –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- ‚ùå –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã

**–ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**

#### –≠—Ç–∞–ø 1: Kaspi QR (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- [ ] –ü–æ–ª—É—á–∏—Ç—å API credentials (Kaspi Business)
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/billing/kaspi/init` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/billing/kaspi/webhook` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback
- [ ] –õ–æ–≥–∏–∫–∞:
  ```typescript
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
  POST /api/billing/kaspi/init
  {
    clubId: "...",
    planId: "club_50"
  }
  
  Response:
  {
    transactionId: "...",
    qrCodeUrl: "...",
    amount: 5000,
    expiresAt: "2024-12-24T10:00:00Z"
  }
  
  // Webhook –æ—Ç Kaspi
  POST /api/billing/kaspi/webhook
  {
    transactionId: "...",
    status: "SUCCESS",
    paymentId: "kaspi_xxx"
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞:
  1. markTransactionPaid(transactionId, paymentId)
  2. activateSubscription(clubId, planId, periodStart, periodEnd)
  3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  ```

#### –≠—Ç–∞–ø 2: ePay (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ Kaspi
- [ ] Endpoint: `/api/billing/epay/*`

#### –≠—Ç–∞–ø 3: Stripe (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Stripe Checkout
- [ ] Webhooks –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- [ ] Endpoint: `/api/billing/stripe/*`

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [ ] –°–æ–∑–¥–∞—Ç—å `docs/PAYMENT_INTEGRATION.md`

---

### 4. Cleanup –∏—Å—Ç—ë–∫—à–∏—Ö pending –ø–ª–∞—Ç–µ–∂–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** Pending transactions –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ `pending_ttl_minutes`.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤ cron –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏:
  ```typescript
  async function cleanupPendingTransactions() {
    const policy = await getDefaultBillingPolicy();
    const ttlMinutes = policy.pendingTtlMinutes;
    
    const expired = await supabaseAdmin
      .from('billing_transactions')
      .select('*')
      .eq('status', 'pending')
      .lt('created_at', new Date(Date.now() - ttlMinutes * 60 * 1000).toISOString());
    
    for (const tx of expired.data) {
      await markTransactionFailed(tx.id);
      // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–¥–∞–ª–∏—Ç—å draft –∫–ª—É–±–∞, –µ—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω
    }
  }
  ```

---

### 5. Grace period —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å email/Telegram –∑–∞ 3 –¥–Ω—è –¥–æ `current_period_end`
- [ ] –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ `grace`
- [ ] –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞ 2 –¥–Ω—è –¥–æ `grace_until`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –ò–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å SendGrid/Mailgun/Resend

---

### 6. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–æ–≤ –±–µ–∑ –æ–ø–ª–∞—Ç—ã (club_drafts)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—É–±—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–æ –æ–ø–ª–∞—Ç—ã ‚Üí "–ø–æ–ª—É–º—ë—Ä—Ç–≤—ã–µ" –∫–ª—É–±—ã –≤ –ë–î.

**–ò–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
> –ß—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å "–ø–æ–ª—É–º—ë—Ä—Ç–≤—ã–µ" –∫–ª—É–±—ã, –¥–µ–ª–∞–π—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
> - **–í–∞—Ä–∏–∞–Ω—Ç A (–ª—É—á—à–∏–π):** `club_drafts` (–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –¥–æ –æ–ø–ª–∞—Ç—ã)
> - **–í–∞—Ä–∏–∞–Ω—Ç B:** —Ö—Ä–∞–Ω–∏—Ç—å draft –≤ client/local storage (–º–µ–Ω–µ–µ –Ω–∞–¥—ë–∂–Ω–æ)

**–†–µ—à–µ–Ω–∏–µ (–í–∞—Ä–∏–∞–Ω—Ç A):**

```sql
CREATE TABLE public.club_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  plan_id TEXT NOT NULL REFERENCES club_plans(id),
  
  -- Draft –¥–∞–Ω–Ω—ã–µ –∫–ª—É–±–∞
  name TEXT NOT NULL,
  description TEXT,
  city_ids UUID[],
  
  -- Payment intent
  transaction_id UUID REFERENCES billing_transactions(id),
  
  expires_at TIMESTAMPTZ NOT NULL, -- created_at + pending_ttl_minutes
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_club_drafts_user_id ON club_drafts(user_id);
CREATE INDEX idx_club_drafts_expires_at ON club_drafts(expires_at);
```

**Flow:**
1. User –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–ª—É–±"
2. POST `/api/clubs/draft` ‚Üí —Å–æ–∑–¥–∞—ë—Ç draft + transaction (pending)
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `draftId` + `paymentInfo` (QR, —Å—Å—ã–ª–∫–∞)
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: webhook ‚Üí —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± –∏–∑ draft ‚Üí —É–¥–∞–ª–∏—Ç—å draft
5. Cron –æ—á–∏—â–∞–µ—Ç expired drafts

---

### 7. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø–æ –±–∏–ª–ª–∏–Ω–≥—É.

**–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:**
- [ ] MRR (Monthly Recurring Revenue)
- [ ] Churn rate (–æ—Ç—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [ ] Conversion rate (Free ‚Üí Club 50)
- [ ] Paywall –ø–æ–∫–∞–∑—ã –∏ –∫–ª–∏–∫–∏
- [ ] Failed payments

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- Vercel Analytics
- Mixpanel / Amplitude
- Custom dashboard –≤ Supabase

---

### 8. –¢–µ—Å—Ç—ã –¥–ª—è enforcement —Å–∏—Å—Ç–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ–π –ª–æ–≥–∏–∫–∏.

**–ò–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ä–∞–∑–¥–µ–ª 11):**
> –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä:
> - ‚úÖ Free –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±: 402 + reason `CLUB_CREATION_REQUIRES_PLAN`
> - ‚úÖ Free personal event >15 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 402 + `requiredPlanId: club_50`
> - ‚úÖ Club 50 event 51 —É—á–∞—Å—Ç–Ω–∏–∫: 402 + `requiredPlanId: club_500`
> - ‚úÖ Club subscription expired: –ª—é–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ‚Üí 402
> - ‚úÖ Grace period: –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã/–∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ policy
> - ‚úÖ CSV export: Free ‚Üí 402, Club 50+ ‚Üí ok
> - ‚úÖ Paid event: Free ‚Üí 402, Club 50+ ‚Üí ok

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –°–æ–∑–¥–∞—Ç—å `/tests/services/accessControl.test.ts`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vitest / Jest
- [ ] –ú–æ–∫–∏ –¥–ª—è Supabase

```typescript
describe('enforceClubAction', () => {
  it('should throw PaywallError when FREE user creates event with 20 participants', async () => {
    // Mock: no subscription (FREE)
    mockGetClubSubscription.mockResolvedValue(null);
    mockGetPlanById.mockResolvedValue({
      id: 'free',
      maxEventParticipants: 15,
    });
    
    await expect(
      enforceClubAction({
        clubId: 'test-club',
        action: 'CLUB_CREATE_EVENT',
        context: { eventParticipantsCount: 20 },
      })
    ).rejects.toThrow(PaywallError);
  });
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã...
});
```

---

### 9. Admin –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç UI –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

**–§—É–Ω–∫—Ü–∏–∏:**
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (`active`, `grace`, `expired`)
- [ ] –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- [ ] Invalidate plans cache

**Endpoint:**
```typescript
PATCH /api/admin/subscriptions/:clubId
{
  status: "active",
  periodEnd: "2025-01-31T00:00:00Z"
}
```

**UI:** Next.js admin route (protected)

---

### 10. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ FREE –ø–ª–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** FREE –ø–ª–∞–Ω —Ç–µ–ø–µ—Ä—å –≤ `club_plans`, –Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ –Ω–µ –∫–ª—É–±–Ω—ã–π –ø–ª–∞–Ω.

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

**A. –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (—Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ)**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –ø–ª–∞—Ç–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
- ‚ùå –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ FREE ‚â† club plan

**B. –°–æ–∑–¥–∞—Ç—å `personal_plan` —Ç–∞–±–ª–∏—Ü—É**
- ‚úÖ –ß–∏—Å—Ç–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è (FREE –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç clubs)
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚ùå –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (A). FREE –≤ `club_plans` —Å `id='free'` ‚Äî –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.

---

### 11. –£–ª—É—á—à–µ–Ω–∏–µ UX Paywall Modal

**–ò–¥–µ–∏:**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ø–ª–∞–Ω–æ–≤ –ø—Ä—è–º–æ –≤ –º–æ–¥–∞–ª–∫–µ
- [ ] "Quick upgrade" –∫–Ω–æ–ø–∫–∞ (—Å—Ä–∞–∑—É –Ω–∞ payment flow)
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤
- [ ] –ê–Ω–∏–º–∞—Ü–∏—è + —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è

**Mockup:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üöÄ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤           ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  –í–∞—à –ø–ª–∞–Ω: Club 50 (–¥–æ 50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)   ‚îÇ
‚îÇ  –í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏: 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤           ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Club 500 - 15,000‚Ç∏/–º–µ—Å          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ‚úì –î–æ 500 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ‚úì –ü–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ‚úì CSV —ç–∫—Å–ø–æ—Ä—Ç                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ [–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Club 500]           ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã]  [–û—Ç–º–µ–Ω–∞]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 12. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞

**–¢–µ–∫—É—â–µ–µ:** TTL = 5 –º–∏–Ω—É—Ç

**–£–ª—É—á—à–µ–Ω–∏—è:**
- [ ] Event-based invalidation –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤ —á–µ—Ä–µ–∑ admin
- [ ] Warm-up –∫—ç—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ cold start)
- [ ] Metrics: cache hit rate

---

## üìà –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è

### –§–∞–∑–∞ 1: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è (Q1 2025)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: HIGH**

- [ ] –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è PaywallModal (1-2 –¥–Ω—è)
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è accessControl.ts (2-3 –¥–Ω—è)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏ (cron) (2-3 –¥–Ω—è)
- [ ] Cleanup pending transactions (1 –¥–µ–Ω—å)

**–¶–µ–ª—å:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

---

### –§–∞–∑–∞ 2: –ü–ª–∞—Ç—ë–∂–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Q1 2025)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: HIGH**

- [ ] Kaspi QR –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
- [ ] club_drafts –¥–ª—è flow —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–æ–≤ (3-5 –¥–Ω–µ–π)
- [ ] Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ (2-3 –¥–Ω—è)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã end-to-end (3 –¥–Ω—è)

**–¶–µ–ª—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Kaspi.

---

### –§–∞–∑–∞ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ (Q1-Q2 2025)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: MEDIUM**

- [ ] Dashboard –¥–ª—è MRR, churn, conversions (1 –Ω–µ–¥–µ–ª—è)
- [ ] Email/Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (3-5 –¥–Ω–µ–π)
- [ ] A/B —Ç–µ—Å—Ç—ã Paywall Modal (ongoing)

**–¶–µ–ª—å:** –ü–æ–Ω–∏–º–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏.

---

### –§–∞–∑–∞ 4: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (Q2 2025)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: LOW**

- [ ] ePay –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
- [ ] Stripe –¥–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (1 –Ω–µ–¥–µ–ª—è)
- [ ] Admin –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (1-2 –Ω–µ–¥–µ–ª–∏)

**–¶–µ–ª—å:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤, —É–¥–æ–±–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:** `docs/BILLING_AND_LIMITS.md`
- **–≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑:** `docs/BILLING_SYSTEM_ANALYSIS.md`
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** `supabase/migrations/20241215_*.sql`

### –í–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏

- [Kaspi Business API](https://kaspi.kz/business) ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [Stripe Billing](https://stripe.com/docs/billing) ‚Äî best practices
- [SaaS Metrics](https://www.saastr.com/saas-metrics-guide/) ‚Äî MRR, Churn, CAC

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∏—á–∏

- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** `docs/NOTIFICATION_SYSTEM_HARDENED.md`
- **RLS –∞—É–¥–∏—Ç:** `docs/RLS_COVERAGE_AUDIT.md`
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** `docs/ARCHITECTURE_REVIEW_REDIRECTS.md`

---

## üîÑ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –î–∞—Ç–∞ | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|--------|-----------|
| 2024-12-23 | 1.0 | –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã v2.0) |

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

- **–ü–ª–∞–Ω (Plan)** ‚Äî —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω (`free`, `club_50`, etc.)
- **–ü–æ–¥–ø–∏—Å–∫–∞ (Subscription)** ‚Äî –∑–∞–ø–∏—Å—å –≤ `club_subscriptions` —Å —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (Transaction)** ‚Äî –∑–∞–ø–∏—Å—å –≤ `billing_transactions` (–∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π)
- **Enforcement** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ `enforceClubAction()`
- **Paywall** ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º upgrade

### –°–æ–≥–ª–∞—à–µ–Ω–∏—è –æ –∫–æ–¥–µ

- **–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `enforceClubAction()`
- **–í—Å–µ repo —Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç domain types (camelCase), –∞ –Ω–µ DB types (snake_case)
- **PaywallError** ‚Äî –≤—Å–µ–≥–¥–∞ 402, –≤—Å–µ–≥–¥–∞ —Å `cta: {href: "/pricing"}`
- **FREE –ø–ª–∞–Ω** ‚Äî `null` –≤ `club_subscriptions`, –Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `club_plans`

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 23 –¥–µ–∫–∞–±—Ä—è 2024  
**–ê–≤—Ç–æ—Ä:** AI Assistant (–∞–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã Need4Trip)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª–µ–Ω (–æ—Ç—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é v2.0)

