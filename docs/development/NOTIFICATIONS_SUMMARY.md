# üîî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## üìù –ß—Ç–æ —ç—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å–æ–±—ã—Ç–∏—è—Ö.

---

## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å–æ–±—ã—Ç–∏—è—Ö
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –∫–∞–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ö–æ—Ç—è—Ç –ø–æ–ª—É—á–∞—Ç—å (—á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å)
- ‚úÖ –í–∏–¥—è—Ç –∏—Å—Ç–æ—Ä–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É–≤–µ–¥–æ–º–ª—è—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö

---

## üéØ –¢—Ä–∏–≥–≥–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏** - "–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ 20 –¥–µ–∫–∞–±—Ä—è, 14:00"
2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞ —Å–±–æ—Ä–∞** - "–ú–µ—Å—Ç–æ —Å–±–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–æ: –ê–ó–° –ö–∞–∑–∞—Ö–º—ã—Å, –ê–ª–º–∞—Ç—ã"
3. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª** - "–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç–∏—è"
4. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤** - "–õ–∏–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω: 15 —á–µ–ª–æ–≤–µ–∫"
5. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã** - "–ò–∑–º–µ–Ω–∏–ª–∏—Å—å —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã"
6. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É** - "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
7. **–û—Ç–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏—è** - "‚ùå –°–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)

```
1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ
   ‚Üì
2. –°–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
   ‚Üì
3. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å Telegram ID
   ‚Üì
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–∫–∞–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã)
   ‚Üì
5. –î–æ–±–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å (notification_queue)
   ‚Üì
6. Cron job (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å
   ‚Üì
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Telegram Bot API
   ‚Üì
8. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (notification_logs)
```

---

## üìä –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (3 —Ç–∞–±–ª–∏—Ü—ã)
1. **`user_notification_settings`** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã)
2. **`notification_queue`** - –æ—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (pending ‚Üí sent/failed)
3. **`notification_logs`** - –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### Backend Services
1. **`notifications.ts`** - –¥–µ—Ç–µ–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å, –æ–±—Ä–∞–±–æ—Ç–∫–∞
2. **`telegram/bot.ts`** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### API Routes
1. **`GET/PATCH /api/profile/notifications`** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **`POST /api/cron/process-notifications`** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (cron job)

### Frontend
1. **`/profile/notifications`** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. **`NotificationSettingsForm`** - —Ñ–æ—Ä–º–∞ —Å toggle –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏

---

## üöÄ –ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é?

### –®–∞–≥ 1: –ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
1. **`NOTIFICATIONS_ARCHITECTURE.md`** - –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –¥–µ—Ç–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω
2. **`NOTIFICATIONS_IMPLEMENTATION_PLAN.md`** - –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Å code examples

### –®–∞–≥ 2: –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥
- **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): Phase 1 ‚Üí Phase 2 ‚Üí ... ‚Üí Phase 11
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**: Database + Types ‚Üí Backend Services ‚Üí Frontend UI

### –®–∞–≥ 3: –ù–∞—á–∞—Ç—å —Å –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
supabase/migrations/20241217_create_notifications_system.sql

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
supabase db push
```

---

## üì¶ –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞?

### Environment Variables
```bash
TELEGRAM_BOT_TOKEN=xxx        # –û—Ç @BotFather –≤ Telegram
CRON_SECRET=yyy               # –°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã cron endpoint
NEXT_PUBLIC_APP_URL=https://need4trip.kz
```

### Vercel Cron Job
```json
{
  "crons": [{
    "path": "/api/cron/process-notifications",
    "schedule": "*/5 * * * *"
  }]
}
```

---

## ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

- **Full implementation:** 3 –¥–Ω—è (24 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã)
- **MVP (–±–µ–∑ UI):** 1.5 –¥–Ω—è (—Ç–æ–ª—å–∫–æ backend + cron)
- **MVP (—Å UI):** 2 –¥–Ω—è

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞
- Database & Types: 3 —á–∞—Å–∞
- Repos: 3 —á–∞—Å–∞
- Telegram Bot: 2 —á–∞—Å–∞
- Core Service: 4 —á–∞—Å–∞
- Event Integration: 2 —á–∞—Å–∞
- API Routes: 2 —á–∞—Å–∞
- Frontend UI: 4 —á–∞—Å–∞
- Deployment: 1 —á–∞—Å
- Testing: 3 —á–∞—Å–∞
- Documentation: 1 —á–∞—Å

---

## üé® –ü—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã
```
üîî –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Å–æ–±—ã—Ç–∏–∏

üìå –ü–æ–∫–∞—Ç—É—à–∫–∞ –≤ –¢—É—Ä–≥–µ–Ω—å

‚è∞ –ò–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–∞—Ç–∞ –∏–ª–∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
–ù–æ–≤–æ–µ –≤—Ä–µ–º—è: 20 –¥–µ–∫–∞–±—Ä—è 2025 –≥., 14:00

[–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Üí](https://need4trip.kz/events/xxx)
```

### –û—Ç–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏—è
```
üîî –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Å–æ–±—ã—Ç–∏–∏

üìå –ü–æ–∫–∞—Ç—É—à–∫–∞ –≤ –¢—É—Ä–≥–µ–Ω—å

‚ùå –°–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ

[–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Üí](https://need4trip.kz/events/xxx)
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Telegram Bot Token —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–µ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ)
- ‚úÖ RLS policies - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ Cron endpoint –∑–∞—â–∏—â–µ–Ω CRON_SECRET
- ‚úÖ Rate limiting —á–µ—Ä–µ–∑ scheduled_for
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —Å max attempts (–Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)

---

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### Current design (–¥–æ 1000 —Å–æ–±—ã—Ç–∏–π/–¥–µ–Ω—å)
- Cron job –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- Batch size 50 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
- Max capacity: ~14,400 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π/–¥–µ–Ω—å

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ
- –£–≤–µ–ª–∏—á–∏—Ç—å batch size (100, 200)
- –ß–∞—â–µ –∑–∞–ø—É—Å–∫–∞—Ç—å cron (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
- –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ workers
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å queue service (BullMQ, RabbitMQ)

---

## üêõ Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è?
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `notification_queue` - –µ—Å—Ç—å –ª–∏ pending –∑–∞–ø–∏—Å–∏?
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Vercel Cron logs - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–∏ job?
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `notification_logs` - –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏?
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram Bot Token - –≤–∞–ª–∏–¥–Ω—ã–π?

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?
1. –ï—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `telegram_id`?
2. –í–∫–ª—é—á–µ–Ω—ã –ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö?
3. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞?
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `notification_logs` –¥–ª—è —ç—Ç–æ–≥–æ user_id

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Vercel Cron Jobs](https://vercel.com/docs/cron-jobs)
- [Supabase RLS](https://supabase.com/docs/guides/auth/row-level-security)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–§–∏—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏:
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã —Å–æ–±—ã—Ç–∏—è —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω
- ‚úÖ –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–æ–±—ã—Ç–∏—è –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚úÖ Failed —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è retry –¥–æ 3 —Ä–∞–∑
- ‚úÖ –í—Å–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ `notification_logs`

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å? –û—Ç–∫—Ä–æ–π—Ç–µ `NOTIFICATIONS_IMPLEMENTATION_PLAN.md` –∏ –Ω–∞—á–Ω–∏—Ç–µ —Å Phase 1!** üöÄ
