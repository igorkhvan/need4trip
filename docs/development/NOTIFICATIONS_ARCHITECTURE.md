# üîî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å–æ–±—ã—Ç–∏—è—Ö —á–µ—Ä–µ–∑ Telegram Bot API.

---

## üéØ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
1. **–¢—Ä–∏–≥–≥–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏:
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ—Å—Ç–∞ —Å–±–æ—Ä–∞ (–≥–æ—Ä–æ–¥, locationText)
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –û—Ç–º–µ–Ω–µ —Å–æ–±—ã—Ç–∏—è (DELETE)
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã (isPaid, price, currency)
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É
   - –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º (–±—É–¥—É—â–∞—è —Ñ–∏—á–∞)

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –∫–∞–∂–¥—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ
3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è:
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Ç–∞–±–ª–∏—Ü–∞ `event_participants`)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `telegram_id` (–±–µ–∑ Telegram ID –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, retry –ª–æ–≥–∏–∫–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞, batch processing
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Telegram Bot Token —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, RLS
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–∏–∑–∞–π–Ω

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### 1.1 –¢–∞–±–ª–∏—Ü–∞ `user_notification_settings`
–•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```sql
CREATE TABLE user_notification_settings (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  
  -- Event update triggers
  notify_on_datetime_change BOOLEAN DEFAULT true,
  notify_on_location_change BOOLEAN DEFAULT true,
  notify_on_rules_change BOOLEAN DEFAULT false,
  notify_on_max_participants_change BOOLEAN DEFAULT true,
  notify_on_payment_change BOOLEAN DEFAULT true,
  notify_on_vehicle_requirement_change BOOLEAN DEFAULT true,
  notify_on_event_cancelled BOOLEAN DEFAULT true,
  
  -- Future triggers (reserved for phase 2)
  notify_on_organizer_message BOOLEAN DEFAULT true,
  notify_on_new_participant BOOLEAN DEFAULT false,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- RLS policies
ALTER TABLE user_notification_settings ENABLE ROW LEVEL SECURITY;

-- Users can read/update only their own settings
CREATE POLICY user_settings_select ON user_notification_settings
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY user_settings_update ON user_notification_settings
  FOR UPDATE USING (auth.uid() = user_id);

-- Auto-insert default settings when user is created
CREATE POLICY user_settings_insert ON user_notification_settings
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

#### 1.2 –¢–∞–±–ª–∏—Ü–∞ `notification_queue`
–û—á–µ—Ä–µ–¥—å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

```sql
CREATE TYPE notification_status AS ENUM ('pending', 'sent', 'failed', 'cancelled');
CREATE TYPE notification_trigger AS ENUM (
  'datetime_change',
  'location_change',
  'rules_change',
  'max_participants_change',
  'payment_change',
  'vehicle_requirement_change',
  'event_cancelled',
  'organizer_message'
);

CREATE TABLE notification_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- References
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Notification details
  trigger_type notification_trigger NOT NULL,
  message TEXT NOT NULL,
  telegram_chat_id TEXT NOT NULL,
  
  -- Status tracking
  status notification_status DEFAULT 'pending',
  attempts INT DEFAULT 0,
  max_attempts INT DEFAULT 3,
  last_error TEXT,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  sent_at TIMESTAMPTZ,
  scheduled_for TIMESTAMPTZ DEFAULT now(), -- –¥–ª—è rate limiting
  
  -- Indexes
  INDEX idx_notification_queue_status (status),
  INDEX idx_notification_queue_scheduled (scheduled_for),
  INDEX idx_notification_queue_event (event_id),
  INDEX idx_notification_queue_user (user_id)
);

-- RLS: Only service role can access
ALTER TABLE notification_queue ENABLE ROW LEVEL SECURITY;
```

#### 1.3 –¢–∞–±–ª–∏—Ü–∞ `notification_logs`
–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ debugging.

```sql
CREATE TABLE notification_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  trigger_type notification_trigger NOT NULL,
  
  status notification_status NOT NULL,
  message TEXT NOT NULL,
  error_message TEXT,
  
  sent_at TIMESTAMPTZ DEFAULT now(),
  
  -- Indexes for analytics
  INDEX idx_notification_logs_event (event_id),
  INDEX idx_notification_logs_user (user_id),
  INDEX idx_notification_logs_trigger (trigger_type),
  INDEX idx_notification_logs_status (status),
  INDEX idx_notification_logs_sent_at (sent_at)
);

-- RLS: Users can view their own notification history
ALTER TABLE notification_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY notification_logs_select ON notification_logs
  FOR SELECT USING (auth.uid() = user_id);
```

---

### 2. Backend Services

#### 2.1 Notification Service (`src/lib/services/notifications.ts`)

**Responsibility:** –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.

```typescript
// –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
export type NotificationTrigger = 
  | 'datetime_change'
  | 'location_change'
  | 'rules_change'
  | 'max_participants_change'
  | 'payment_change'
  | 'vehicle_requirement_change'
  | 'event_cancelled'
  | 'organizer_message';

// –î–µ—Ç–µ–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–æ–±—ã—Ç–∏–∏
export interface EventChanges {
  dateTimeChanged: boolean;
  locationChanged: boolean;
  rulesChanged: boolean;
  maxParticipantsChanged: boolean;
  paymentChanged: boolean;
  vehicleRequirementChanged: boolean;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–∏–µ –ø–æ–ª—è —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
 */
export function detectEventChanges(
  oldEvent: DbEvent,
  newData: EventUpdateInput
): EventChanges {
  return {
    dateTimeChanged: newData.dateTime !== undefined && 
      new Date(newData.dateTime).getTime() !== new Date(oldEvent.date_time).getTime(),
    
    locationChanged: (
      (newData.cityId !== undefined && newData.cityId !== oldEvent.city_id) ||
      (newData.locationText !== undefined && newData.locationText !== oldEvent.location_text)
    ),
    
    rulesChanged: newData.rules !== undefined && newData.rules !== oldEvent.rules,
    
    maxParticipantsChanged: newData.maxParticipants !== undefined && 
      newData.maxParticipants !== oldEvent.max_participants,
    
    paymentChanged: (
      (newData.isPaid !== undefined && newData.isPaid !== oldEvent.is_paid) ||
      (newData.price !== undefined && newData.price !== oldEvent.price) ||
      (newData.currencyCode !== undefined && newData.currencyCode !== oldEvent.currency_code)
    ),
    
    vehicleRequirementChanged: newData.vehicleTypeRequirement !== undefined && 
      newData.vehicleTypeRequirement !== oldEvent.vehicle_type_requirement,
  };
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
 */
export async function getParticipantsNotificationSettings(
  eventId: string
): Promise<Array<{ userId: string; telegramId: string; settings: NotificationSettings }>> {
  // 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏—è
  // 2. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å telegram_id
  // 3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Ö notification_settings
  // 4. –í–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
}

/**
 * –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
 */
export async function queueParticipantNotifications(
  eventId: string,
  changes: EventChanges,
  eventTitle: string
): Promise<{ queued: number; skipped: number }> {
  // 1. –ü–æ–ª—É—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
  // 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  // 3. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å message
  // 4. –î–æ–±–∞–≤–∏—Ç—å –≤ notification_queue
  // 5. –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ cron job –∏–ª–∏ API route)
 */
export async function processNotificationQueue(
  batchSize: number = 10
): Promise<{ sent: number; failed: number }> {
  // 1. –ü–æ–ª—É—á–∏—Ç—å pending —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (limit batchSize)
  // 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram Bot API
  // 3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å (sent/failed)
  // 4. –ü—Ä–∏ failed - —É–≤–µ–ª–∏—á–∏—Ç—å attempts, reschedule
  // 5. –ó–∞–ø–∏—Å–∞—Ç—å –≤ notification_logs
  // 6. –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
}
```

#### 2.2 Telegram Bot Service (`src/lib/services/telegram/bot.ts`)

**Responsibility:** –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram Bot API.

```typescript
/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot
 */
export async function sendTelegramMessage(
  chatId: string,
  message: string,
  options?: {
    parseMode?: 'Markdown' | 'HTML';
    disableWebPagePreview?: boolean;
  }
): Promise<{ success: boolean; error?: string }> {
  const botToken = process.env.TELEGRAM_BOT_TOKEN;
  
  if (!botToken) {
    throw new Error('TELEGRAM_BOT_TOKEN is not configured');
  }
  
  try {
    const response = await fetch(
      `https://api.telegram.org/bot${botToken}/sendMessage`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: options?.parseMode ?? 'Markdown',
          disable_web_page_preview: options?.disableWebPagePreview ?? true,
        }),
      }
    );
    
    if (!response.ok) {
      const errorData = await response.json();
      return {
        success: false,
        error: errorData.description || 'Unknown Telegram API error',
      };
    }
    
    return { success: true };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Network error',
    };
  }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è
 */
export function formatEventChangeMessage(
  eventTitle: string,
  eventId: string,
  trigger: NotificationTrigger,
  details?: Record<string, any>
): string {
  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://need4trip.kz';
  const eventUrl = `${baseUrl}/events/${eventId}`;
  
  let message = `üîî *–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Å–æ–±—ã—Ç–∏–∏*\n\n`;
  message += `üìå ${eventTitle}\n\n`;
  
  switch (trigger) {
    case 'datetime_change':
      message += `‚è∞ –ò–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–∞—Ç–∞ –∏–ª–∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è\n`;
      if (details?.newDateTime) {
        message += `–ù–æ–≤–æ–µ –≤—Ä–µ–º—è: ${formatDateTime(details.newDateTime)}\n`;
      }
      break;
    
    case 'location_change':
      message += `üìç –ò–∑–º–µ–Ω–∏–ª–æ—Å—å –º–µ—Å—Ç–æ —Å–±–æ—Ä–∞\n`;
      if (details?.newLocation) {
        message += `–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ: ${details.newLocation}\n`;
      }
      break;
    
    case 'rules_change':
      message += `üìã –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç–∏—è\n`;
      break;
    
    case 'max_participants_change':
      message += `üë• –ò–∑–º–µ–Ω–∏–ª—Å—è –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n`;
      if (details?.newLimit) {
        message += `–ù–æ–≤—ã–π –ª–∏–º–∏—Ç: ${details.newLimit} —á–µ–ª–æ–≤–µ–∫\n`;
      }
      break;
    
    case 'payment_change':
      message += `üí∞ –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã\n`;
      break;
    
    case 'vehicle_requirement_change':
      message += `üöó –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É\n`;
      break;
    
    case 'event_cancelled':
      message += `‚ùå *–°–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ*\n`;
      break;
  }
  
  message += `\n[–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Üí](${eventUrl})`;
  
  return message;
}
```

---

### 3. Integration Points

#### 3.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `updateEvent`

```typescript
// –í src/lib/services/events.ts, —Ñ—É–Ω–∫—Ü–∏—è updateEvent

export async function updateEvent(
  id: string,
  input: unknown,
  currentUser: CurrentUser | null
) {
  // ... existing validation ...
  
  const parsed = eventUpdateSchema.parse(input);
  const existing = await getEventById(id);
  
  // ‚ú® –ù–û–í–û–ï: –î–µ—Ç–µ–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const changes = detectEventChanges(existing, parsed);
  
  // ... existing business logic ...
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ë–î
  const result = await updateEventRecord(id, {
    title: parsed.title,
    // ... other fields
  });
  
  // ‚ú® –ù–û–í–û–ï: –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥—å –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  if (hasAnyChanges(changes)) {
    await queueParticipantNotifications(id, changes, result.title).catch(err => {
      // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º update —Å–æ–±—ã—Ç–∏—è –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å
      console.error('[updateEvent] Failed to queue notifications:', err);
    });
  }
  
  // ... existing hydration and return ...
}
```

#### 3.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `deleteEvent`

```typescript
export async function deleteEvent(
  id: string,
  currentUser: CurrentUser | null
) {
  // ... existing validation ...
  
  const existing = await getEventById(id);
  
  // ‚ú® –ù–û–í–û–ï: –£–≤–µ–¥–æ–º–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–± –æ—Ç–º–µ–Ω–µ
  await queueEventCancelledNotifications(id, existing.title).catch(err => {
    console.error('[deleteEvent] Failed to queue cancellation notifications:', err);
  });
  
  // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
  await deleteEventRecord(id);
}
```

---

### 4. API Routes

#### 4.1 User Notification Settings API

**GET/PATCH `/api/profile/notifications`**

```typescript
// src/app/api/profile/notifications/route.ts

export async function GET(request: NextRequest) {
  const currentUser = await getCurrentUser();
  if (!currentUser) {
    return respondError(new AuthError('Unauthorized'));
  }
  
  const settings = await getUserNotificationSettings(currentUser.id);
  return respondJSON({ settings });
}

export async function PATCH(request: NextRequest) {
  const currentUser = await getCurrentUser();
  if (!currentUser) {
    return respondError(new AuthError('Unauthorized'));
  }
  
  const body = await request.json();
  const parsed = notificationSettingsUpdateSchema.parse(body);
  
  const updated = await updateUserNotificationSettings(currentUser.id, parsed);
  return respondJSON({ settings: updated });
}
```

#### 4.2 Notification Queue Processor (Cron Job)

**POST `/api/cron/process-notifications`**

```typescript
// src/app/api/cron/process-notifications/route.ts

export async function POST(request: NextRequest) {
  // Verify cron secret (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return respondError(new AuthError('Unauthorized'));
  }
  
  try {
    const result = await processNotificationQueue(50); // batch size 50
    return respondJSON({
      success: true,
      sent: result.sent,
      failed: result.failed,
    });
  } catch (error) {
    console.error('[cron] Failed to process notifications:', error);
    return respondError(error);
  }
}
```

---

### 5. Frontend Components

#### 5.1 Notification Settings Page

**`src/app/profile/notifications/page.tsx`**

```tsx
// –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ
export default async function NotificationsPage() {
  const currentUser = await getCurrentUser();
  
  if (!currentUser) {
    redirect('/');
  }
  
  const settings = await getUserNotificationSettings(currentUser.id);
  
  return (
    <div className="container max-w-2xl py-8">
      <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>
      <NotificationSettingsForm initialSettings={settings} />
    </div>
  );
}
```

#### 5.2 Notification Settings Form

**`src/components/profile/notification-settings-form.tsx`**

```tsx
'use client';

export function NotificationSettingsForm({ initialSettings }) {
  const [settings, setSettings] = useState(initialSettings);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const handleToggle = (key: string, value: boolean) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };
  
  const handleSave = async () => {
    setIsSubmitting(true);
    try {
      await fetch('/api/profile/notifications', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings),
      });
      toast({ title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã' });
    } catch (error) {
      toast({ title: '–û—à–∏–±–∫–∞', description: getErrorMessage(error) });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  return (
    <Card>
      <div className="space-y-4">
        <NotificationToggle
          label="–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏"
          description="–ö–æ–≥–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–µ–Ω—è–µ—Ç –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è"
          checked={settings.notify_on_datetime_change}
          onCheckedChange={(val) => handleToggle('notify_on_datetime_change', val)}
        />
        
        <NotificationToggle
          label="–ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞ —Å–±–æ—Ä–∞"
          description="–ö–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –≥–æ—Ä–æ–¥ –∏–ª–∏ –º–µ—Å—Ç–æ —Å–±–æ—Ä–∞"
          checked={settings.notify_on_location_change}
          onCheckedChange={(val) => handleToggle('notify_on_location_change', val)}
        />
        
        {/* ... –¥—Ä—É–≥–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã ... */}
        
        <Button onClick={handleSave} disabled={isSubmitting}>
          {isSubmitting ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'}
        </Button>
      </div>
    </Card>
  );
}
```

---

## üìù –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: Database & Core Services (–î–µ–Ω—å 1-2)

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_notification_settings`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `notification_queue`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `notification_logs`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å ENUM —Ç–∏–ø—ã
   - ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS policies
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å indexes –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

2. **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (DB layer)**
   - ‚úÖ `src/lib/db/notificationSettingsRepo.ts`
   - ‚úÖ `src/lib/db/notificationQueueRepo.ts`
   - ‚úÖ `src/lib/db/notificationLogsRepo.ts`

3. **–¢–∏–ø—ã –∏ —Å—Ö–µ–º—ã**
   - ‚úÖ `src/lib/types/notification.ts`
   - ‚úÖ Zod schemas –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### Phase 2: Notification Service (–î–µ–Ω—å 2-3)

4. **Core notification service**
   - ‚úÖ `src/lib/services/notifications.ts`
     - `detectEventChanges()`
     - `queueParticipantNotifications()`
     - `processNotificationQueue()`

5. **Telegram bot integration**
   - ‚úÖ `src/lib/services/telegram/bot.ts`
     - `sendTelegramMessage()`
     - `formatEventChangeMessage()`
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å `TELEGRAM_BOT_TOKEN` –≤ `.env.example`

### Phase 3: Event Integration (–î–µ–Ω—å 3-4)

6. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ events service**
   - ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `updateEvent()` –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `deleteEvent()` –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—Ç–º–µ–Ω–µ
   - ‚úÖ Unit tests –¥–ª—è `detectEventChanges()`

### Phase 4: API & Cron (–î–µ–Ω—å 4-5)

7. **API routes**
   - ‚úÖ `GET/PATCH /api/profile/notifications`
   - ‚úÖ `POST /api/cron/process-notifications` (protected endpoint)

8. **Cron job setup**
   - ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Vercel Cron –∏–ª–∏ –∞–Ω–∞–ª–æ–≥
   - ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è deployment

### Phase 5: Frontend (–î–µ–Ω—å 5-6)

9. **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**
   - ‚úÖ `src/app/profile/notifications/page.tsx`
   - ‚úÖ `src/components/profile/notification-settings-form.tsx`
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ –ø—Ä–æ—Ñ–∏–ª–µ

10. **Testing & Polish**
    - ‚úÖ E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ flow
    - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    - ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### Phase 6: Monitoring & Documentation (–î–µ–Ω—å 6-7)

11. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
    - ‚úÖ Logging –¥–ª—è –≤—Å–µ—Ö notification –æ–ø–µ—Ä–∞—Ü–∏–π
    - ‚úÖ Dashboard –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

12. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
    - ‚úÖ README –¥–ª—è setup (Telegram Bot Token)
    - ‚úÖ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    - ‚úÖ User guide –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Telegram Bot Token** - —Ç–æ–ª—å–∫–æ –≤ server-side env vars
2. **RLS policies** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
3. **Cron endpoint** - –∑–∞—â–∏—â–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
4. **Rate limiting** - —á–µ—Ä–µ–∑ `scheduled_for` –≤ –æ—á–µ—Ä–µ–¥–∏
5. **Validation** - Zod schemas –¥–ª—è –≤—Å–µ—Ö inputs

---

## üöÄ Deployment Checklist

### Environment Variables

```bash
# .env.local
TELEGRAM_BOT_TOKEN=your_bot_token_here
CRON_SECRET=random_secure_string_for_cron_auth
NEXT_PUBLIC_APP_URL=https://need4trip.kz
```

### Vercel Setup

1. –î–æ–±–∞–≤–∏—Ç—å env vars –≤ Vercel dashboard
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Vercel Cron:
   ```json
   {
     "crons": [{
       "path": "/api/cron/process-notifications",
       "schedule": "*/5 * * * *"
     }]
   }
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: `supabase db push`

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö/failed –∑–∞ –ø–µ—Ä–∏–æ–¥
   - –°—Ä–µ–¥–Ω–∏–π retry count
   - –¢–æ–ø —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
   - –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ/–Ω–µ–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏
   - Telegram API latency
   - Queue backlog size

### SQL –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
SELECT 
  trigger_type,
  status,
  COUNT(*) as count
FROM notification_logs
WHERE sent_at >= NOW() - INTERVAL '7 days'
GROUP BY trigger_type, status
ORDER BY count DESC;

-- –°—Ä–µ–¥–Ω–∏–π retry count –¥–ª—è failed —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
SELECT 
  AVG(attempts) as avg_retries
FROM notification_queue
WHERE status = 'failed';
```

---

## üîÑ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (Phase 2)

1. **Rich notifications**: Inline buttons –≤ Telegram (–û—Ç–∫—Ä—ã—Ç—å —Å–æ–±—ã—Ç–∏–µ, –û—Ç–ø–∏—Å–∞—Ç—å—Å—è)
2. **Digest mode**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. **Email fallback**: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ email –µ—Å–ª–∏ –Ω–µ—Ç Telegram ID
4. **Push notifications**: Web Push –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
5. **Notification center**: –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ UI
6. **A/B testing**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## ‚ùì FAQ

**Q: –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞?**
A: Telegram API –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É, –º—ã –ø–æ–º–µ—Ç–∏–º –∫–∞–∫ `failed` –∏ –Ω–µ –±—É–¥–µ–º retry –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ (max 3 attempts).

**Q: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Å–ø–∞–º–∞?**
A: Rate limiting —á–µ—Ä–µ–∑ `scheduled_for`, batch processing, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

**Q: –ß—Ç–æ –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è?**
A: –£–≤–µ–ª–∏—á–∏—Ç—å batch size –≤ cron job, –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ workers, –¥–æ–±–∞–≤–∏—Ç—å priority queue.

**Q: –ù—É–∂–Ω–æ –ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å message templates –≤ –ë–î?**
A: –ù–µ—Ç, –ø–æ–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–∞—Ä–¥–∫–æ–¥–∞ –≤ `formatEventChangeMessage()`. –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è A/B testing - –≤—ã–Ω–µ—Å–µ–º –≤ –ë–î.

---

## üìö –°—Å—ã–ª–∫–∏

- [Telegram Bot API Documentation](https://core.telegram.org/bots/api#sendmessage)
- [Vercel Cron Jobs](https://vercel.com/docs/cron-jobs)
- [Supabase Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)

