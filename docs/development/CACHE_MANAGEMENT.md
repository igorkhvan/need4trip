# Управление кэшем

## Обзор

Приложение использует StaticCache для кэширования статических справочных данных из БД:

| Данные | TTL | Репозиторий |
|--------|-----|-------------|
| Планы подписок | 5 минут | `planRepo.ts` |
| Марки авто | 24 часа | `carBrandRepo.ts` |
| Валюты | 24 часа | `currencyRepo.ts` |
| Категории событий | 1 час | `eventCategoryRepo.ts` |
| Популярные города | 1 час | `cityRepo.ts` |
| Типы автомобилей | 24 часа | `vehicleTypeRepo.ts` |

## Проблема: Изменения в БД не видны

Если вы изменили данные в БД (например, увеличили `max_event_participants` в `club_plans`), но в интерфейсе не видите обновлений, причина в кэше.

**Решения:**

### 1. Подождите TTL (рекомендуется)
Кэш автоматически обновится через указанное время:
- Планы подписок: **5 минут**
- Валюты, марки авто, типы авто: **24 часа**
- Категории, города: **1 час**

### 2. Перезапустите сервер
```bash
# Останавливаем сервер (Ctrl+C)
# Запускаем заново
npm run dev
```

### 3. Сбросьте кэш через API (мгновенно)
```bash
curl -X POST http://localhost:3000/api/admin/cache/clear
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "message": "All static caches cleared successfully",
    "timestamp": "2024-12-14T12:00:00.000Z"
  }
}
```

После сброса кэша все данные будут перезагружены из БД при следующем запросе.

## Для production

В production используйте один из способов:

1. **Встроенный TTL** - данные обновятся автоматически
2. **API endpoint** - вызовите `/api/admin/cache/clear` после обновления БД
3. **Деплой** - при новом деплое кэш пересоздается

## Настройка TTL

Чтобы изменить TTL для конкретного кэша, отредактируйте соответствующий репозиторий:

```typescript
// Пример: src/lib/db/planRepo.ts
const plansCache = new StaticCache<ClubPlan>(
  {
    ttl: 5 * 60 * 1000, // ← Измените это значение (в миллисекундах)
    name: 'club_plans',
  },
  async () => { /* ... */ },
  (plan) => plan.id
);
```

**Рекомендации:**
- Часто изменяемые данные: 1-5 минут
- Редко изменяемые данные: 1-24 часа
- Не ставьте слишком короткий TTL - это создает нагрузку на БД

## Мониторинг кэша

Можно получить статистику всех кэшей (в будущем):

```typescript
import { getAllCacheStats } from "@/lib/cache/staticCache";

const stats = getAllCacheStats();
console.log(stats);
// [
//   { name: 'club_plans', size: 4, age: 123456, valid: true, loading: false },
//   { name: 'car_brands', size: 150, age: 456789, valid: true, loading: false },
//   ...
// ]
```

## Troubleshooting

**Q: Я сбросил кэш, но данные все равно старые**
- Убедитесь, что изменения действительно сохранились в БД
- Проверьте правильность SQL миграции
- Проверьте что приложение подключено к правильной БД

**Q: После сброса кэша приложение тормозит**
- Это нормально: кэш загружается заново из БД
- Все кэши загружаются ленив: только когда к ним обращаются
- Загрузка происходит один раз, после чего работает быстро

**Q: Можно ли отключить кэш для разработки?**
- Да, установите очень короткий TTL (например, 1000 = 1 секунда)
- Или добавьте ENV переменную для контроля TTL
