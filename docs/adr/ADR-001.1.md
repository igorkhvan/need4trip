# ADR-001.1 — Transport-Agnostic Authentication Context Resolution

**Status:** Accepted
**Date:** 2026-01-27 (extended 2026-01-29)
**Supersedes:** ADR-001 (clarification & extension)
**Decision Scope:** User-initiated domains (Clubs, Billing, Events, Profile)
**Owner:** Platform / Architecture

---

## 1. Context

The Clubs domain contains multiple **viewer-dependent surfaces**, including but not limited to:

* Members preview
* Members list
* Membership requests
* Club settings

Access to these surfaces depends on **correct resolution of the current viewer’s authentication context**.

During Clubs Profile and Members Preview work, the following architectural issue was identified:

* Authentication context is sometimes resolved from **middleware-injected headers**
* Sometimes from **cookies**
* In **Next.js App Router**, server-to-server (RSC/SSR → internal API) fetches:

  * do **not guarantee middleware execution**
  * do **not forward cookies by default**

This results in **transport-dependent auth behavior**, where:

* the same viewer appears authenticated in one path
* and anonymous in another

This violates SSOT_CLUBS_DOMAIN principles and produces UI-level inconsistencies (e.g. Members Preview disappearing not because of RBAC, but because auth was not resolved).

---

## 2. Problem Statement

Authentication resolution is currently **coupled to transport mechanics** instead of being a **domain-level invariant**.

Specifically:

* Some backend routes assume middleware headers exist
* Others assume cookies exist
* Neither assumption is universally valid across:

  * browser requests
  * RSC/SSR internal fetch
  * future edge / worker contexts

This makes auth behavior:

* non-deterministic
* environment-dependent
* difficult to reason about and audit

---

## 3. Decision

### 3.1 Canonical Rule

**All viewer-dependent backend logic MUST resolve authentication via a single transport-agnostic resolver.**

No viewer-dependent route may:

* directly read cookies
* directly read middleware headers
* implement custom auth fallbacks

---

### 3.2 Canonical Resolution Order (Fallback Chain)

Authentication context MUST be resolved in the following order:

1. **Middleware-derived auth headers** (if present and trusted)
2. **Cookie-based session authentication**
3. **Anonymous viewer**

This guarantees:

* deterministic behavior
* consistent semantics across transports
* a single logical outcome for the same viewer

---

### 3.3 Mandatory Resolver

A single canonical function MUST exist and be used by all viewer-dependent routes:

```
resolveCurrentUser(req) → User | null
```

This resolver:

* encapsulates the fallback chain
* is the only allowed entry point for auth resolution
* returns `null` for anonymous viewers

---

## 4. Trust Model (Non-Negotiable)

### 4.1 Middleware Headers Are Trusted — But Never From the Client

To prevent header spoofing:

* Middleware MUST strip any incoming `x-n4t-auth-*` headers
* Middleware MAY inject canonical `x-n4t-auth-*` headers **only after verifying cookies/session**
* Backend routes MAY trust `x-n4t-auth-*` headers **only under this invariant**

Direct client-supplied auth headers are **never trusted**.

---

## 5. Scope of Enforcement

This ADR applies to:

* `/api/clubs/[id]/members/preview`
* `/api/clubs/[id]/members`
* `/api/clubs/[id]/requests/*`
* `/api/clubs/[id]/settings/*`
* any future viewer-dependent Clubs routes

It does **not**:

* change RBAC rules
* change UI contracts
* change visibility semantics

It **only** standardizes auth context resolution.

---

## 6. Internal Fetch Requirement (App Router)

Because internal RSC/SSR fetches may bypass middleware:

* Internal API calls MUST forward cookies explicitly
* A single internal fetch helper MUST exist for this purpose
* Viewer-dependent sections MUST use that helper

This ensures the fallback chain always has at least one valid transport.

> **Note:** ADR-001.5 extends this guidance by establishing that **RSC MUST NOT call authenticated HTTP API routes at all**. RSC should call service-layer functions directly. See ADR-001.5 for rationale and enforcement rules.

---

## 7. Consequences

### Positive

* Deterministic auth behavior across all environments
* Elimination of “auth works locally but not in SSR” bugs
* Clear audit boundary for future domains
* Simplifies reasoning about viewer-dependent UI behavior

### Trade-offs

* Requires refactoring existing routes to use the canonical resolver
* Introduces a small abstraction layer (intentional and accepted)

---

## 8. Compliance Checklist

A route is compliant with ADR-001.1 **only if**:

* [ ] It uses `resolveCurrentUser(req)` for auth
* [ ] It does not read cookies or auth headers directly
* [ ] Middleware strips and reinjects auth headers
* [ ] Internal fetch uses the cookie-forwarding helper
* [ ] UI visibility follows RBAC, not transport side-effects

---

## 9. Implementation Status

**Status:** Implemented and Enforced

**Implementation completed:** 2026-01-27

### 9.1 What was implemented

- Canonical resolver `resolveCurrentUser(req?)` created in `lib/auth/resolveCurrentUser.ts`
- All Clubs API routes updated to use the canonical resolver
- Middleware updated to strip spoofable auth headers and inject trusted `x-user-id`
- SSR internal fetches updated to forward cookies consistently

### 9.2 Legacy deprecation

The following legacy auth helper functions are **deprecated** but not yet removed:

- `getCurrentUser()` — replaced by `resolveCurrentUser()`
- `getCurrentUserFromMiddleware()` — replaced by `resolveCurrentUser(req)`
- `getCurrentUserWithFallback()` — replaced by `resolveCurrentUser(req)`

These functions remain in codebase for backward compatibility with non-Clubs routes. They are tracked as architectural debt (see `ARCHITECTURAL_DEBT_LOG.md`).

### 9.3 Enforcement

- New viewer-dependent routes MUST use `resolveCurrentUser(req?)`
- Direct cookie/header reading outside `lib/auth` is architecturally forbidden
- SSOT_ARCHITECTURE.md §8.2 is the normative reference

---

## 10. Scope Extension (2026-01-29)

### 10.1 Extended Applicability

The canonical user auth model defined in this ADR applies beyond the Clubs domain.

**Domains covered by this ADR:**
- Clubs (original scope)
- Billing (user-initiated domain)
- Events (user-facing operations)
- Profile (user-facing operations)

All user-initiated domains MUST use `resolveCurrentUser(req?)` as the single auth resolution mechanism.

### 10.2 Explicit Out of Scope

The following contexts are **explicitly NOT covered** by this ADR:

| Context | Why Out of Scope | Future Resolution |
|---------|------------------|-------------------|
| **Admin Context** | Not user-initiated; secret-based auth | Separate ADR if formalization needed |
| **System Context** | Not user-initiated; cron/job auth | Separate ADR if formalization needed |

These contexts:
- MUST NOT use `resolveCurrentUser()`
- Have their own authentication mechanisms (shared secrets)
- Are tracked as architectural debt (see ARCHITECTURAL_DEBT_LOG.md)

### 10.3 Platform Taxonomy Reference

The platform-level auth context taxonomy (User, Admin, System) is now formally defined in:
- **SSOT_ARCHITECTURE.md §8.3** — Auth Context Types (NORMATIVE)

This ADR remains the authoritative source for User Context resolution rationale and implementation details.

---

## 11. Original Status (Historical)

**Accepted. Mandatory for all Clubs viewer-dependent work going forward.**
