# ADR-001: Unified Authentication Context Resolution

**Status:** Accepted  
**Date:** 2026-01-27  
**Decision Owner:** Architecture / Platform

---

## Context

The system contains multiple viewer-dependent domains (e.g. Clubs â†’ Members Preview, Membership Requests, Settings, future internal sections) that rely on authentication and authorization to determine data visibility.

During implementation and audit of the Club Profile page, an inconsistency was discovered:

- Different API routes resolve the current user using different mechanisms:
  - Cookie-based resolution (`getCurrentUser()`)
  - Header-based resolution (`getCurrentUserFromMiddleware()`)
- Server-to-server fetches (SSR / RSC internal fetch) do not forward cookies by default.
- As a result, the same user may be:
  - authorized in one part of the system (e.g. Club Settings)
  - treated as unauthenticated in another (e.g. Members Preview)

This leads to inconsistent behavior where viewer-dependent sections may be hidden despite valid membership, even though domain data is correct.

SSOT explicitly requires:
- viewer-dependent data to rely on a resolved authentication context
- consistent interpretation of membership and access rules

Therefore, a canonical approach to authentication context resolution is required.

---

## Decision

The system adopts a **single canonical authentication context resolution model** for all viewer-dependent backend operations.

### Core decision

- All backend routes that enforce access control (membership, roles, visibility, permissions) MUST resolve authentication via a unified auth resolver.
- The auth resolver MUST return the same logical authentication context regardless of:
  - request origin (browser, SSR, server-to-server fetch)
  - transport mechanism (cookies, internal headers)

Authentication context is defined as:
- authenticated user identity (or explicit absence thereof)
- user identifier
- authorization-relevant attributes

The system MUST NOT rely on implicit transport behavior (e.g. cookie forwarding) for correctness.

---

## Scope

This decision applies to:

- Club Members Preview
- Club Members list
- Membership requests
- Club settings
- Any future viewer-dependent club sections
- Any future domains with membership / role-based access (e.g. Teams, Workspaces, Projects)

This decision does NOT apply to:

- Public, auth-agnostic data (e.g. public Events Preview)
- Purely aggregated, non-viewer-dependent fields

---

## Alternatives Considered

### Alternative A: Cookie-only authentication

**Description:**
Rely exclusively on cookies for auth resolution.

**Rejected because:**
- Fails in server-to-server fetch contexts
- Fragile in SSR / Edge environments
- Couples correctness to transport behavior

---

### Alternative B: Per-route auth strategy

**Description:**
Allow each route to choose its own auth mechanism (cookies or headers).

**Rejected because:**
- Leads to inconsistent behavior
- Increases cognitive load
- Reintroduces the same class of bugs
- Violates SSOT invariants implicitly

---

### Alternative C: Client-only fetching for protected sections

**Description:**
Move viewer-dependent data fetching to the client to ensure cookies are always present.

**Rejected because:**
- Degrades UX
- Introduces hydration delays
- Breaks SSR consistency
- Treats a backend design issue as a frontend workaround

---

## Consequences

### Positive

- Single, predictable access control model
- Consistent behavior across SSR, API, and internal fetches
- Reduced risk of future authorization bugs
- Clear foundation for future viewer-dependent domains

### Negative / Costs

- Requires refactoring existing routes to use the canonical auth resolver
- Introduces a small upfront implementation cost

These costs are considered acceptable and necessary.

---

## Relationship to SSOT

- SSOT defines **what must be true** at the domain level (viewer-dependent access, membership semantics).
- This ADR defines **how the system technically enforces those guarantees**.

If a conflict arises:
- **SSOT takes precedence**
- This ADR may be revised or superseded

---

## Status

This decision is **Accepted** and considered **canonical** for the system.

All new viewer-dependent backend functionality MUST follow this decision.

