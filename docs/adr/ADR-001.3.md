# ADR-001.3 — System Context

**Status:** Accepted  
**Date:** 2026-01-29  
**Extends:** ADR-001, ADR-001.1, ADR-001.2  
**Decision Scope:** Background jobs and cron tasks (`/api/cron/*`)  
**Owner:** Platform / Architecture

---

## 1. Context

ADR-001 and ADR-001.1 established the canonical authentication context model for **user-initiated** domains (Clubs, Billing, Events, Profile).

ADR-001.2 formalized **Admin Context** as a first-class architectural concept for administrative operations.

SSOT_ARCHITECTURE.md §8.3 defines a platform-level auth context taxonomy with three context types:

* **User Context** — end users interacting with the platform
* **Admin Context** — internal administrative actions
* **System Context** — background jobs and cron tasks

This ADR formalizes **System Context** as a first-class architectural concept.

### Current State

System routes (`/api/cron/*`) and background jobs currently:

* authenticate via `CRON_SECRET` or Vercel cron header (`x-vercel-cron`)
* perform scheduled operations (notification processing, cleanup tasks)
* have no explicit auth context object
* have no system actor identity (task execution is logged, but no standardized marker)
* rely on implicit "not a user" convention by simply not calling `resolveCurrentUser()`

This approach was acceptable for early product stage but creates architectural ambiguity as the platform matures and more background jobs are added.

---

## 2. Problem Statement

### 2.1 System Actions Bypass User Auth Intentionally But Implicitly

System operations have fundamentally different semantics than user operations:

* they are not initiated by end users
* they have no user identity to attribute
* they operate on system-level schedules or triggers
* they require different authorization mechanisms (secrets, Vercel cron headers)

Currently, system routes indicate "not a user" by **absence** — they simply don't call `resolveCurrentUser()`. This is an implicit convention, not an explicit architectural decision.

### 2.2 Without Explicit Context, Intent Is Unclear

Services called by system routes cannot distinguish:

* "this call has no user because it's anonymous"
* "this call has no user because it's a system-triggered job"

This conflates two distinct scenarios and makes:

* auditing difficult (what triggered this operation?)
* debugging harder (was this supposed to have a user context?)
* future policy enforcement impossible (e.g., "only system context can do X")

### 2.3 Hard to Scale Jobs Safely and Consistently

As the system grows, more background jobs will be added:

* notification processing (existing)
* data cleanup tasks
* scheduled aggregations
* external sync jobs

Without a consistent system context model:

* each job implements its own ad-hoc authentication
* audit trails are inconsistent
* there's no clear contract for "what system jobs can and cannot do"

---

## 3. Decision

### 3.1 SystemContext Is a First-Class Auth Context

The system recognizes **SystemContext** as a distinct, first-class authentication context type alongside UserContext and AdminContext.

SystemContext represents:

* an authenticated system actor
* performing scheduled or triggered operations
* with secret-based or Vercel-provided authentication
* without end-user identity

### 3.2 SystemContext Is NOT a User Context

System routes:

* MUST NOT use `resolveCurrentUser()`
* MUST NOT perform user-scoped mutations (unless explicitly designed and justified)
* MUST NOT access user-specific data without explicit audit justification

This separation is mandatory and non-negotiable.

### 3.3 System Routes MUST Explicitly Resolve SystemContext

Every system route MUST explicitly authenticate and obtain SystemContext.

**Resolution pattern:**

```
resolveSystemContext(req) → SystemContext | throws 403
```

This resolution:

* verifies `x-vercel-cron` header (when present)
* falls back to `CRON_SECRET` via `Authorization: Bearer <secret>` header
* returns a SystemContext on success
* throws `Forbidden` on failure

**Rules:**

* System auth validation MUST be explicit in each route handler
* SystemContext resolution logic MUST be centralized (single canonical module)
* Direct header reading outside the canonical system auth module is FORBIDDEN

### 3.4 SystemContext MUST Be Passed Explicitly to Services

When system routes call service layer functions:

* the SystemContext MUST be passed explicitly as a parameter
* services MAY accept an optional context discriminator to adjust behavior
* implicit "no user means system" convention is DEPRECATED

---

## 4. SystemContext Definition (Conceptual)

### 4.1 Shape

```typescript
interface SystemContext {
  type: 'system';
  trigger: 'cron' | 'manual';
  verifiedBy: 'vercel-cron' | 'secret';
  jobName: string;
}
```

### 4.2 Semantics

| Property | Values | Description |
|----------|--------|-------------|
| `type` | `'system'` | Discriminator for context type |
| `trigger` | `'cron'` \| `'manual'` | How the job was triggered |
| `verifiedBy` | `'vercel-cron'` \| `'secret'` | Authentication mechanism used |
| `jobName` | string | Identifier for the specific job (e.g., `'process-notifications'`) |

### 4.3 What SystemContext Does NOT Contain

SystemContext explicitly lacks:

* user identity (no `userId`, no `email`)
* admin identity
* session identifier
* permission claims (system has implicit full access within its defined scope)

---

## 5. Verification & Trust Model (NORMATIVE)

### 5.1 Trust Principle

SystemContext is trusted **only if verification passes**. An unverified request MUST be rejected with 403 Forbidden.

### 5.2 Verification Sources

SystemContext verification accepts the following sources, in order of precedence:

| Source | Header | When Used | Trust Level |
|--------|--------|-----------|-------------|
| Vercel Cron | `x-vercel-cron: 1` | Vercel-triggered scheduled jobs | High (platform-injected) |
| Shared Secret | `Authorization: Bearer <CRON_SECRET>` | Manual triggers, testing, external schedulers | Medium (secret-based) |

**Verification logic:**

1. If `x-vercel-cron` header is present and equals `1` → trusted (Vercel-injected)
2. Else if `Authorization` header matches `Bearer <CRON_SECRET>` → trusted (secret-verified)
3. Else → reject with 403

### 5.3 Security Invariants

* `CRON_SECRET` MUST NOT be logged
* `CRON_SECRET` MUST NOT be exposed in error responses
* `CRON_SECRET` MUST be stored in environment variables, never in code
* Vercel cron header cannot be spoofed from external requests (platform guarantee)

---

## 6. Audit Requirements (NORMATIVE)

### 6.1 Minimum Audit Fields

System actions MUST be logged with the following fields:

| Field | Source | Purpose |
|-------|--------|---------|
| `action` / `jobName` | SystemContext.jobName | What job was executed |
| `timestamp` | Server clock | When it executed |
| `route` / `path` | Request path | Which endpoint was called |
| `result` | Success/failure + summary | Outcome of execution |

### 6.2 Optional Audit Fields

| Field | Source | When Available |
|-------|--------|----------------|
| `requestId` | Correlation ID / Vercel request ID | If request tracing is enabled |
| `duration` | Execution timing | For performance monitoring |
| `processedCount` | Job-specific | For batch operations |

### 6.3 What MUST NOT Be Logged

* `CRON_SECRET` value
* Authorization header value
* PII (unless strictly required and policy-approved)

---

## 7. Scope of Enforcement

### 7.1 In Scope

This ADR applies to:

* `/api/cron/process-notifications` (API-048, API-049)
* Any future `/api/cron/*` endpoints
* Any background workers or scheduled tasks that authenticate via CRON_SECRET

### 7.2 Out of Scope

This ADR does NOT cover:

* User-facing routes (covered by ADR-001.1)
* Admin routes (covered by ADR-001.2)
* Webhook receivers from external services (may need separate consideration)
* Client-side or UI components

---

## 8. Consequences

### 8.1 Positive

* **Explicit actor model** — System operations have a named, typed context
* **Clear separation** — User, Admin, and System concerns are architecturally distinct
* **Safer job growth** — New jobs follow a consistent authentication pattern
* **Audit foundation** — Minimum audit structure is defined and enforceable
* **Future observability** — SystemContext enables structured logging and monitoring
* **Policy enforcement path** — Future restrictions on system actions become possible

### 8.2 Trade-offs

* **No job-level permissions** — All system jobs have equivalent access (no fine-grained control)
* **Single shared secret** — CRON_SECRET is shared across all jobs (no per-job isolation)
* **Implementation cost** — Existing cron routes may need refactoring to use canonical resolver

### 8.3 Migration Path

1. **Phase 1 (this ADR):** Formalize SystemContext concept, document current implementation
2. **Phase 2 (future):** Implement canonical `resolveSystemContext(req)` resolver
3. **Phase 3 (future):** Migrate existing cron routes to use canonical resolver
4. **Phase 4 (future):** Add job-level permissions if operational need arises

---

## 9. Out of Scope

The following are explicitly **NOT addressed** by this ADR:

### 9.1 Full Job Framework / Queue Redesign

* Job queue infrastructure (Redis, SQS, etc.)
* Job retry logic
* Dead-letter queues
* Job scheduling beyond Vercel cron

**Why deferred:** Current Vercel cron + simple jobs pattern is sufficient. Queue infrastructure adds complexity without current operational need.

### 9.2 Fine-Grained Job Permissions

* Per-job secrets
* Job-level access control (e.g., "job X can only modify table Y")
* Job capability declarations

**Why deferred:** All current jobs are trusted internal operations. Fine-grained permissions add complexity without current benefit.

### 9.3 Persisted Audit Store

* Compliance-grade audit logs
* Immutable audit storage
* Audit log query UI
* Long-term audit retention

**Why deferred:** Current console logging is sufficient for debugging. Persisted audit store requires infrastructure investment.

### 9.4 External Scheduler Integration

* Integration with external cron services
* Multi-environment job orchestration
* Job dependency graphs

**Why deferred:** Vercel cron meets current needs.

---

## 10. Implementation Status

**Status:** Conceptual (Not Yet Implemented)

### 10.1 Current State

Cron routes currently validate `x-vercel-cron` header or `CRON_SECRET` inline. No `SystemContext` type or canonical resolver exists in code.

### 10.2 Implementation Plan

When implementation begins:

1. Create `lib/auth/systemContext.ts` with `SystemContext` type
2. Create `resolveSystemContext(req)` canonical resolver
3. Refactor existing cron routes to use canonical resolver
4. Pass SystemContext explicitly to service layer functions
5. Add structured audit logging for system actions
6. Update SSOT_API.md with implementation details

### 10.3 Enforcement

* New system/cron routes MUST use canonical `resolveSystemContext(req)`
* Direct `x-vercel-cron` or `CRON_SECRET` header reading outside `lib/auth` is FORBIDDEN
* SSOT_API.md §2.3.3 is the normative reference for system route auth rules

---

## 11. References

| Document | Section | Relevance |
|----------|---------|-----------|
| ADR-001 | — | Canonical user auth model foundation |
| ADR-001.1 | §10.2 | System context explicitly out of scope for user auth |
| ADR-001.2 | — | Admin context formalization (parallel pattern) |
| SSOT_ARCHITECTURE.md | §8.3 | Platform-level auth context taxonomy |
| SSOT_API.md | §2.3.3 | System route auth rules |
| ARCHITECTURAL_DEBT_LOG.md | DEBT-006 | System context formalization debt |

---

## 12. Status

**Accepted. Mandatory for all system/cron route work going forward.**

All new `/api/cron/*` endpoints MUST follow the principles established in this ADR. Existing endpoints should be migrated when touched.

This ADR resolves DEBT-006 (System Context Formalization) at the architectural decision level. Implementation work is tracked separately.
