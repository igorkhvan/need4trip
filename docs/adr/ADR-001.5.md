# ADR-001.5 — RSC Access Rule (Service-First, No HTTP API)

**Status:** Accepted  
**Date:** 2026-01-29  
**Extends:** ADR-001, ADR-001.1  
**Decision Scope:** React Server Components and internal data fetching  
**Owner:** Platform / Architecture

---

## 1. Context

ADR-001 and ADR-001.1 established the canonical authentication context model for viewer-dependent domains. ADR-001.1 specifically defines the **transport-agnostic resolver** `resolveCurrentUser(req)` as the single entry point for user authentication.

During debugging of a production issue (Clubs → Events visibility), the following architectural conflict was discovered:

### 1.1 The Conflict

React Server Components (RSC) executing on the server attempted to fetch viewer-dependent data via authenticated HTTP API routes (e.g., `internalApiFetch('/api/clubs/...')`).

This pattern fails for the following reasons:

| Layer | Behavior | Problem |
|-------|----------|---------|
| **RSC execution** | Runs on server, no browser context | No native cookie handling |
| **Middleware** | Strips untrusted auth headers on public routes | Cannot receive spoofable headers |
| **`cookies()`** | Unreliable during server-to-server fetch | May be empty or stale |
| **HTTP hop** | Adds latency and complexity | Unnecessary for same-process calls |

### 1.2 Why This Is Not a Bug

The middleware behavior (stripping untrusted headers) is **correct and intentional** — it prevents header spoofing attacks.

The problem is architectural: **RSC should not be calling authenticated HTTP API routes in the first place**.

### 1.3 Discovery Context

This issue surfaced during Clubs → Events visibility debugging, where:

* Club events appeared correctly in API responses
* The same events disappeared when RSC called API routes internally
* Root cause: RSC fetch had no valid auth context to forward

---

## 2. Problem Statement

### 2.1 RSC Execution Model vs HTTP API Model

HTTP API routes are designed for:

* Browser clients (cookies present)
* External clients (token-based auth)
* Middleware enforcement (header validation)

RSC execution:

* Runs on the server (same process as API routes)
* Has no browser context
* Cannot reliably forward cookies via internal fetch
* Should not bypass middleware by injecting trusted headers

### 2.2 Mixing Models Causes Failures

When RSC calls authenticated HTTP API routes:

1. RSC executes `internalApiFetch('/api/...')`
2. Request arrives at middleware
3. Middleware strips any injected auth headers (security requirement)
4. API route receives anonymous request
5. Viewer-dependent data is incorrectly filtered or hidden

This is **not fixable** without compromising middleware security.

### 2.3 No Safe Workaround Within HTTP Model

Potential workarounds and why they are rejected:

| Workaround | Why Rejected |
|------------|--------------|
| Inject trusted headers from RSC | Middleware cannot distinguish RSC from attacker |
| Disable header stripping | Compromises security (header spoofing) |
| Use `credentials: 'include'` | Does not work reliably for server-to-server |
| Forward cookies manually | `cookies()` unreliable in RSC fetch context |

---

## 3. Decision

### 3.1 Canonical Rule (NORMATIVE)

**React Server Components MUST NOT call authenticated HTTP API routes.**

RSC MUST call service-layer functions directly.

### 3.2 Auth Resolution for RSC

RSC MUST resolve authentication **once** at the page/component boundary using the canonical resolver from ADR-001.1:

```
const currentUser = await resolveCurrentUser();
```

The resolved `currentUser` MUST be passed explicitly to service-layer functions.

### 3.3 Service Layer Is the Data Source for RSC

RSC data fetching MUST follow this pattern:

```
RSC → Service Layer → Repository → Database
```

RSC MUST NOT follow this pattern:

```
RSC → HTTP API Route (❌ FORBIDDEN)
```

### 3.4 HTTP API Routes Are for External Clients Only

HTTP API routes (`/api/*`) serve:

* Browser clients (via `fetch` from client components)
* External integrations
* Webhooks

HTTP API routes do NOT serve:

* RSC internal data fetching
* Server-to-server calls within the same process

---

## 4. Consequences

### 4.1 Positive

* **Security preserved** — Middleware continues to strip untrusted headers; no weakening required
* **Clear architectural boundaries** — RSC uses service layer; browser uses HTTP API
* **Better performance** — No internal HTTP hops; direct function calls are faster
* **Predictable behavior** — Auth resolution happens once, explicitly
* **Debuggability** — No hidden auth failures in internal fetches

### 4.2 Trade-offs

* **Developer discipline** — Developers must know which layer to call from RSC
* **No code sharing** — RSC cannot reuse HTTP API route handlers directly
* **Refactoring cost** — Existing RSC → API patterns must be migrated

### 4.3 Migration Impact

Existing code patterns that violate this rule:

* `internalApiFetch('/api/...')` from RSC
* `fetch('/api/...')` from server components

Must be migrated to:

* Direct service-layer function calls
* Explicit `currentUser` passing

---

## 5. Examples

### 5.1 Forbidden Pattern (❌)

```typescript
// ❌ FORBIDDEN: RSC calling authenticated HTTP API
async function ClubEventsPage({ params }: Props) {
  const events = await internalApiFetch(`/api/clubs/${params.id}/events`);
  return <EventsList events={events} />;
}
```

### 5.2 Correct Pattern (✅)

```typescript
// ✅ CORRECT: RSC calling service layer directly
async function ClubEventsPage({ params }: Props) {
  // Note: resolveCurrentUser() called without `req` argument in RSC context.
  // RSC runs in server component execution context where cookies() is available
  // directly, so no NextRequest object is needed (unlike API route handlers).
  const currentUser = await resolveCurrentUser();
  const events = await getClubEvents(params.id, currentUser);
  return <EventsList events={events} />;
}
```

### 5.3 Client Component Pattern (✅)

```typescript
// ✅ CORRECT: Client component calling HTTP API
'use client';

function ClubEventsClient({ clubId }: Props) {
  const { data: events } = useSWR(`/api/clubs/${clubId}/events`);
  return <EventsList events={events} />;
}
```

---

## 6. Enforcement Notes

### 6.1 Code Review Requirements

Code review MUST reject:

* RSC → `internalApiFetch('/api/...')` calls
* RSC → `fetch('/api/...')` calls for authenticated endpoints
* Any RSC pattern that relies on internal HTTP for auth-protected data

### 6.2 Middleware MUST NOT Be Modified

Middleware header-stripping behavior MUST NOT be weakened to support RSC auth.

Any proposal to "trust RSC headers" or "whitelist internal callers" violates security invariants and MUST be rejected.

### 6.3 Service Layer Is the Single Source of Truth

For viewer-dependent data in RSC:

* Service layer functions are the canonical data source
* Auth context is passed explicitly
* No implicit transport-based auth resolution

---

## 7. Scope of Enforcement

### 7.1 In Scope

This ADR applies to:

* All React Server Components (`app/**/*.tsx` without `'use client'`)
* All server-side data fetching from pages and layouts
* Any SSR/RSC internal fetch pattern

### 7.2 Out of Scope

This ADR does NOT cover:

* Client components (`'use client'`) — they SHOULD use HTTP API
* External clients — they MUST use HTTP API
* Cron/system routes — covered by ADR-001.3

---

## 8. Implementation Status

**Status:** Accepted (Architectural Rule)

### 8.1 Current State

This ADR documents an architectural rule discovered during production debugging. The rule is effective immediately.

### 8.2 Enforcement

* New RSC code MUST follow the service-first pattern
* Existing violations should be migrated when touched
* No infrastructure changes required — this is a code pattern rule

---

## 9. References

| Document | Section | Relevance |
|----------|---------|-----------|
| ADR-001 | — | Canonical user auth model foundation |
| ADR-001.1 | §3, §6 | Transport-agnostic resolver; internal fetch requirements |
| SSOT_ARCHITECTURE.md | §8 | Auth context types and rules |
| BACKEND_AUDIT_CLUB_EVENT_VISIBILITY.md | — | Discovery context (production issue) |

---

## 10. Summary

| Aspect | Rule |
|--------|------|
| **RSC → HTTP API (authenticated)** | ❌ FORBIDDEN |
| **RSC → Service Layer** | ✅ REQUIRED |
| **Auth resolution in RSC** | Once via `resolveCurrentUser()`, passed explicitly |
| **Middleware modification** | ❌ NOT ALLOWED |
| **Client → HTTP API** | ✅ ALLOWED (normal pattern) |

---

## 11. Status

**Accepted. Mandatory for all RSC data fetching work going forward.**

All React Server Components that require authenticated/viewer-dependent data MUST call service-layer functions directly. HTTP API routes are reserved for browser and external clients only.
