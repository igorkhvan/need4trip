# üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

## –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω UNIQUE constraint –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ.

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

**–û–ø—Ü–∏—è –ê: –ß–µ—Ä–µ–∑ Supabase Dashboard (Production)**
```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
cat supabase/migrations/20241222_add_user_registration_unique.sql

# –í—Å—Ç–∞–≤–∏—Ç—å –≤ SQL Editor –Ω–∞ dashboard.supabase.com –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
```

**–û–ø—Ü–∏—è –ë: –ß–µ—Ä–µ–∑ CLI (Development)**
```bash
npx supabase db push
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞
SELECT indexname FROM pg_indexes 
WHERE tablename = 'event_participants' 
  AND indexname = 'idx_event_participants_user_unique';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–µ–π
SELECT event_id, user_id, COUNT(*) 
FROM event_participants
WHERE user_id IS NOT NULL
GROUP BY event_id, user_id
HAVING COUNT(*) > 1;
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω, –¥—É–±–ª–µ–π –Ω–µ—Ç.

### 3. –ö–æ–¥ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω ‚úÖ

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `src/lib/errors.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `isUniqueViolationError`
- ‚úÖ `src/lib/services/participants.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ constraint violation
- ‚úÖ `src/lib/utils/eventPermissions.ts` - —É–¥–∞–ª–µ–Ω–∞ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# 1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
# 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞
# ‚úÖ –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –æ—à–∏–±–∫–∞ "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ"

# 3. –û—Ç–∫—Ä—ã—Ç—å —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
# ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞
```

---

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω UNIQUE constraint
CREATE UNIQUE INDEX idx_event_participants_user_unique 
ON event_participants(event_id, user_id)
WHERE user_id IS NOT NULL;
```

### –ö–æ–¥
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** -50% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (–±—ã–ª–æ 2, —Å—Ç–∞–ª–æ 1)
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –æ—Ç race conditions
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ú–µ–Ω—å—à–µ –∫–æ–¥–∞, –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

---

## üîß –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```sql
-- –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å
DROP INDEX IF EXISTS idx_event_participants_user_unique;
```

---

## üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. `docs/FIX_DUPLICATE_REGISTRATION.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è.

